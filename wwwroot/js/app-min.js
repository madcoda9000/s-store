import{start,route,set2FAGuard}from"/js/router.js";import{api,initCsrfToken}from"/js/api.js";import{logger}from"/js/logger.js";import{initI18n}from"/js/i18n.js";import{registerLogin}from"/js/views/login.js";import{registerLogout}from"/js/views/logout.js";import{registerHome}from"/js/views/home.js";import{registerAdminUsers}from"/js/views/admin-users.js";import{registerProfile}from"/js/views/profile.js";import{registerRegister}from"/js/views/register.js";import{registerVerifyEmail}from"/js/views/verify-email.js";import{registerForgotPassword}from"/js/views/forgot-password.js";import{registerResetPassword}from"/js/views/reset-password.js";import{registerSetup2fa}from"/js/views/setup-2fa.js";import{registerVerify2fa}from"/js/views/verify-2fa.js";import{registerSystemLogs}from"./views/system-logs.js";import{registerMailLogs}from"./views/mail-logs.js";import{registerAuditLogs}from"./views/audit-logs.js";import{icon,Icons}from"/js/icons.js";export async function checkAuth(){try{return await api("/auth/me")}catch{return null}}export async function requires2FASetup(){try{const e=await api("/auth/me");return 1===e.twoFactorEnforced&&!e.twoFactorEnabled}catch{return!1}}function protect(e){return async t=>{await checkAuth()?await e(t):location.hash="/login"}}function initTheme(){const e=document.documentElement,t=localStorage.getItem("theme"),r=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light",s=t||r;e.setAttribute("data-theme",s),updateThemeToggleIcon(),document.addEventListener("click",(t=>{const r=t.target;if(r.closest("#theme-toggle")||r.closest("#auth-theme-toggle")){const t="light"===e.getAttribute("data-theme")?"dark":"light";e.setAttribute("data-theme",t),localStorage.setItem("theme",t),updateThemeToggleIcon()}}))}function updateThemeToggleIcon(){const e=document.getElementById("theme-toggle");if(!e)return;const t=document.documentElement.getAttribute("data-theme"),r=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light",s=t||r;e.innerHTML=icon("dark"===s?Icons.SUN:Icons.MOON,"icon icon-lg")}function setupTokenRefresh(){document.addEventListener("visibilitychange",(async()=>{if("visible"===document.visibilityState){await checkAuth()&&await initCsrfToken()}}))}registerLogin(route),registerLogout(route),registerHome(route),registerAdminUsers(route),registerProfile(route),registerRegister(route),registerVerifyEmail(route),registerForgotPassword(route),registerResetPassword(route),registerSetup2fa(route),registerVerify2fa(route),registerSystemLogs(route),registerMailLogs(route),registerAuditLogs(route),route("/404",(e=>{e.innerHTML='\n    <div class="auth-container">\n      <div class="auth-wrapper">\n        <div class="card auth-card">\n          <div class="auth-header">\n            <div class="from">\n              <h1 class="text-4xl">404</h1>\n              <p class="text-muted">Page not found</p>\n            </div>\n          </div>\n          <a href="#/login" class="btn btn-primary btn-block">Go to Login</a>\n        </div>\n      </div>\n    </div>'})),document.addEventListener("DOMContentLoaded",(async()=>{initTheme(),await initI18n(),await initCsrfToken(),setupTokenRefresh(),set2FAGuard(requires2FASetup),start(),logger.setupGlobalErrorHandler()}));export{protect,logger,updateThemeToggleIcon};