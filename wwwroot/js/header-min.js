import{icon,Icons}from"./icons.js";import{updateThemeToggleIcon}from"./app.js";import{setLanguage,getCurrentLanguage,getSupportedLanguages,onLanguageChange}from"./i18n.js";let globalEventsInitialized=!1;export function updateHeader(e){const n=e.roles&&e.roles.includes("Admin"),o=document.getElementById("main-header");o&&o.classList.remove("hidden"),globalEventsInitialized||(initializeGlobalEvents(),globalEventsInitialized=!0),setupMobileMenu(),updateNavigation(n),updateProfileDropdown(e),updateLanguageSelector(),updateThemeToggleIcon()}export function hideHeader(){const e=document.getElementById("main-header");e&&e.classList.add("hidden")}function initializeGlobalEvents(){document.addEventListener("click",(e=>{const n=e.target,o=document.getElementById("mobile-menu-toggle"),t=document.getElementById("mobile-menu-overlay"),s=document.getElementById("main-nav");if(o&&t&&s){if(n.closest("#mobile-menu-toggle")){e.stopPropagation();return void(s.classList.contains("show")?(s.classList.remove("show"),t.classList.remove("show"),o.innerHTML=icon(Icons.MENU,"icon icon-lg"),document.body.style.overflow=""):(s.classList.add("show"),t.classList.add("show"),o.innerHTML=icon(Icons.X,"icon icon-lg"),document.body.style.overflow="hidden"))}if(n.closest("#mobile-menu-overlay"))return s.classList.remove("show"),t.classList.remove("show"),o.innerHTML=icon(Icons.MENU,"icon icon-lg"),void(document.body.style.overflow="");if(n.closest(".nav-link")&&s.classList.contains("show"))return s.classList.remove("show"),t.classList.remove("show"),o.innerHTML=icon(Icons.MENU,"icon icon-lg"),void(document.body.style.overflow="")}const i=n.closest(".nav-dropdown-toggle");if(i){e.stopPropagation();const n=i.nextElementSibling;if(n&&n.classList.contains("nav-dropdown-menu")){document.querySelectorAll(".nav-dropdown-menu.show").forEach((e=>{e!==n&&e.classList.remove("show")})),n.classList.toggle("show");const e=document.getElementById("profile-menu");e&&e.classList.remove("show");const o=document.getElementById("language-menu");o&&o.classList.remove("show")}return}n.closest(".nav-dropdown")||document.querySelectorAll(".nav-dropdown-menu.show").forEach((e=>{e.classList.remove("show")}));const a=document.getElementById("profile-menu");if(n.closest("#profile-toggle")){if(e.stopPropagation(),a){a.classList.toggle("show");const e=document.getElementById("language-menu");e&&e.classList.remove("show"),document.querySelectorAll(".nav-dropdown-menu.show").forEach((e=>{e.classList.remove("show")}))}return}a&&!n.closest(".profile-dropdown")&&a.classList.remove("show");const l=document.getElementById("language-menu");if(n.closest("#language-toggle"))return e.stopPropagation(),void(l&&(l.classList.toggle("show"),a&&a.classList.remove("show"),document.querySelectorAll(".nav-dropdown-menu.show").forEach((e=>{e.classList.remove("show")}))));const c=n.closest(".language-menu-item");if(c){e.stopPropagation();const n=c.getAttribute("data-lang");if(n){const e=document.getElementById("app");e&&(e.style.opacity="0"),setLanguage(n).then((()=>{const o=document.getElementById("language-text");o&&(o.textContent=n.toUpperCase()),l&&l.classList.remove("show");const t=location.hash;t?(location.hash=t+"?lang="+Date.now(),setTimeout((()=>{location.hash.includes("?lang=")&&history.replaceState(null,"",t),e&&(e.style.opacity="1")}),50)):(location.hash="#/home",e&&(e.style.opacity="1"))}))}}else l&&!n.closest(".language-selector")&&l.classList.remove("show")})),document.addEventListener("keydown",(e=>{if("Escape"===e.key){const e=document.getElementById("main-nav"),n=document.getElementById("mobile-menu-overlay"),o=document.getElementById("mobile-menu-toggle");e&&e.classList.contains("show")&&(e.classList.remove("show"),n&&n.classList.remove("show"),o&&(o.innerHTML=icon(Icons.MENU,"icon icon-lg")),document.body.style.overflow="");const t=document.getElementById("profile-menu");t&&t.classList.remove("show");const s=document.getElementById("language-menu");s&&s.classList.remove("show"),document.querySelectorAll(".nav-dropdown-menu.show").forEach((e=>{e.classList.remove("show")}))}})),window.addEventListener("resize",(()=>{if(window.innerWidth>768){const e=document.getElementById("main-nav"),n=document.getElementById("mobile-menu-overlay"),o=document.getElementById("mobile-menu-toggle");e&&e.classList.contains("show")&&(e.classList.remove("show"),n&&n.classList.remove("show"),o&&(o.innerHTML=icon(Icons.MENU,"icon icon-lg")),document.body.style.overflow=""),document.querySelectorAll(".nav-dropdown-menu.show").forEach((e=>{e.classList.remove("show")}))}})),onLanguageChange((e=>{const n=document.getElementById("language-text");n&&(n.textContent=e.toUpperCase())}))}function setupMobileMenu(){const e=document.querySelector(".header-content"),n=document.querySelector(".logo");if(!e||!n)return;const o=e.querySelector(".mobile-menu-toggle"),t=document.querySelector(".mobile-menu-overlay");o&&o.remove(),t&&t.remove();const s=document.createElement("button");s.className="mobile-menu-toggle",s.setAttribute("aria-label","Toggle menu"),s.setAttribute("type","button"),s.setAttribute("id","mobile-menu-toggle"),s.innerHTML=icon(Icons.MENU,"icon icon-lg");const i=document.createElement("div");i.className="mobile-menu-overlay",i.setAttribute("id","mobile-menu-overlay"),e.insertBefore(s,n),document.body.appendChild(i)}function updateNavigation(e){const n=document.getElementById("main-nav");if(!n)return;const o=[];o.push('<a href="#/home" class="nav-link">Home</a>'),e&&(o.push(`\n      <div class="nav-dropdown">\n        <button class="nav-link nav-dropdown-toggle" type="button">\n          Administration ${icon(Icons.CHEVRON_DOWN,"icon icon-sm")}\n        </button>\n        <div class="nav-dropdown-menu">\n          <a href="#/admin/users" class="nav-dropdown-item">${icon(Icons.USERS,"icon")} Users</a>\n          <a href="#/admin/roles" class="nav-dropdown-item">${icon(Icons.SHIELD,"icon")} Roles</a>\n        </div>\n      </div>\n    `),o.push(`\n      <div class="nav-dropdown">\n        <button class="nav-link nav-dropdown-toggle" type="button">\n          Logs ${icon(Icons.CHEVRON_DOWN,"icon icon-sm")}\n        </button>\n        <div class="nav-dropdown-menu">\n          <a href="#/admin/audit" class="nav-dropdown-item">${icon(Icons.FILE_TEXT,"icon")} Audit Logs</a>\n          <a href="#/logs/system" class="nav-dropdown-item">${icon(Icons.SETTINGS,"icon")} System Logs</a>\n          <a href="#/logs/mail" class="nav-dropdown-item">${icon(Icons.MAIL,"icon")} Mail Logs</a>\n        </div>\n      </div>\n    `)),o.push('<a href="#/settings" class="nav-link">Settings</a>'),n.innerHTML=o.join("")}function updateProfileDropdown(e){const n=document.querySelector(".header-actions");if(!n)return;const o=n.querySelector(".profile-dropdown");o&&o.remove();const t=document.createElement("div");t.className="profile-dropdown";const s=getUserInitials(e.userName||e.email),i=e.twoFactorEnabled?"":`<a href="#/setup-2fa" class="profile-menu-item">${icon(Icons.SHIELD,"icon")} Setup 2FA</a>`;t.innerHTML=`\n    <button class="profile-btn" id="profile-toggle" type="button" aria-label="Profile menu">\n      <div class="profile-avatar">${s}</div>\n      ${icon(Icons.CHEVRON_DOWN,"icon icon-sm")}\n    </button>\n    <div class="profile-menu" id="profile-menu">\n      <div class="profile-menu-header">\n        <div class="profile-menu-name">${escapeHtml(e.userName)}</div>\n        <div class="profile-menu-email">${escapeHtml(e.email)}</div>\n      </div>\n      <a href="#/profile" class="profile-menu-item">${icon(Icons.USER,"icon")} Profile</a>\n      ${i}\n      <div class="profile-menu-divider"></div>\n      <a href="#/logout" class="profile-menu-item">${icon(Icons.LOG_OUT,"icon")} Logout</a>\n    </div>\n  `,n.appendChild(t)}function getUserInitials(e){if(!e)return"?";const n=e.split("@")[0].split(/[\s._-]+/).filter((e=>e.length>0));return n.length>=2?(n[0][0]+n[1][0]).toUpperCase():1===n.length&&n[0].length>=2?n[0].substring(0,2).toUpperCase():n[0][0].toUpperCase()}function escapeHtml(e){return e?e.replace(/[&<>"']/g,(e=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[e]))):""}function updateLanguageSelector(){const e=document.querySelector(".header-actions");if(!e)return;const n=e.querySelector(".language-selector");n&&n.remove();const o=getCurrentLanguage(),t=getSupportedLanguages(),s=document.createElement("div");s.className="language-selector";const i=t.map((e=>`\n      <button \n        class="profile-menu-item language-menu-item" \n        data-lang="${e}"\n        type="button">\n        ${e.toUpperCase()}\n      </button>\n    `)).join("");s.innerHTML=`\n    <button class="profile-btn language-btn" id="language-toggle" type="button" aria-label="Change language">\n      <span id="language-text">${o.toUpperCase()}</span>\n      ${icon(Icons.CHEVRON_DOWN,"icon icon-sm")}\n    </button>\n    <div class="profile-menu" id="language-menu">\n      ${i}\n    </div>\n  `;const a=e.querySelector("#theme-toggle");a?e.insertBefore(s,a):e.appendChild(s)}