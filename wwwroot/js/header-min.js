import{icon,Icons}from"./icons.js";import{updateThemeToggleIcon}from"./app.js";import{setLanguage,getCurrentLanguage,getSupportedLanguages,onLanguageChange}from"./i18n.js";let globalEventsInitialized=!1;export function updateHeader(e){const n=e.roles&&e.roles.includes("Admin"),t=document.getElementById("main-header");t&&t.classList.remove("hidden"),globalEventsInitialized||(initializeGlobalEvents(),globalEventsInitialized=!0),setupMobileMenu(),updateNavigation(n),updateProfileDropdown(e),updateLanguageSelector(),updateThemeToggleIcon()}export function hideHeader(){const e=document.getElementById("main-header");e&&e.classList.add("hidden")}function initializeGlobalEvents(){document.addEventListener("click",(e=>{const n=e.target,t=document.getElementById("mobile-menu-toggle"),o=document.getElementById("mobile-menu-overlay"),s=document.getElementById("main-nav");if(t&&o&&s){if(n.closest("#mobile-menu-toggle")){e.stopPropagation();return void(s.classList.contains("show")?(s.classList.remove("show"),o.classList.remove("show"),t.innerHTML=icon(Icons.MENU,"icon icon-lg"),document.body.style.overflow=""):(s.classList.add("show"),o.classList.add("show"),t.innerHTML=icon(Icons.X,"icon icon-lg"),document.body.style.overflow="hidden"))}if(n.closest("#mobile-menu-overlay"))return s.classList.remove("show"),o.classList.remove("show"),t.innerHTML=icon(Icons.MENU,"icon icon-lg"),void(document.body.style.overflow="");if(n.closest(".nav-link")&&s.classList.contains("show"))return s.classList.remove("show"),o.classList.remove("show"),t.innerHTML=icon(Icons.MENU,"icon icon-lg"),void(document.body.style.overflow="")}const i=document.getElementById("profile-menu");if(i){if(n.closest("#profile-toggle"))return e.stopPropagation(),void i.classList.toggle("show");n.closest(".profile-dropdown")||i.classList.remove("show")}})),document.addEventListener("keydown",(e=>{if("Escape"===e.key){const e=document.getElementById("main-nav"),n=document.getElementById("mobile-menu-overlay"),t=document.getElementById("mobile-menu-toggle");e&&e.classList.contains("show")&&(e.classList.remove("show"),n&&n.classList.remove("show"),t&&(t.innerHTML=icon(Icons.MENU,"icon icon-lg")),document.body.style.overflow="");const o=document.getElementById("profile-menu");o&&o.classList.remove("show")}})),window.addEventListener("resize",(()=>{if(window.innerWidth>768){const e=document.getElementById("main-nav"),n=document.getElementById("mobile-menu-overlay"),t=document.getElementById("mobile-menu-toggle");e&&e.classList.contains("show")&&(e.classList.remove("show"),n&&n.classList.remove("show"),t&&(t.innerHTML=icon(Icons.MENU,"icon icon-lg")),document.body.style.overflow="")}}))}function setupMobileMenu(){const e=document.querySelector(".header-content"),n=document.querySelector(".logo");if(!e||!n)return;const t=e.querySelector(".mobile-menu-toggle"),o=document.querySelector(".mobile-menu-overlay");t&&t.remove(),o&&o.remove();const s=document.createElement("button");s.className="mobile-menu-toggle",s.setAttribute("aria-label","Toggle menu"),s.setAttribute("type","button"),s.setAttribute("id","mobile-menu-toggle"),s.innerHTML=icon(Icons.MENU,"icon icon-lg");const i=document.createElement("div");i.className="mobile-menu-overlay",i.setAttribute("id","mobile-menu-overlay"),e.insertBefore(s,n),document.body.appendChild(i)}function updateNavigation(e){const n=document.getElementById("main-nav");if(!n)return;const t=[];t.push('<a href="#/home" class="nav-link">Home</a>'),e&&(t.push('<a href="#/admin/users" class="nav-link">Users</a>'),t.push('<a href="#/admin/roles" class="nav-link">Roles</a>')),t.push('<a href="#/settings" class="nav-link">Settings</a>'),n.innerHTML=t.join("")}function updateProfileDropdown(e){const n=document.querySelector(".header-actions");if(!n)return;const t=n.querySelector(".profile-dropdown");t&&t.remove();const o=document.createElement("div");o.className="profile-dropdown";const s=getUserInitials(e.userName||e.email),i=e.twoFactorEnabled?"":`<a href="#/setup-2fa" class="profile-menu-item">${icon(Icons.SHIELD,"icon")} Setup 2FA</a>`;o.innerHTML=`\n    <button class="profile-btn" id="profile-toggle" type="button" aria-label="Profile menu">\n      <div class="profile-avatar">${s}</div>\n      ${icon(Icons.CHEVRON_DOWN,"icon icon-sm")}\n    </button>\n    <div class="profile-menu" id="profile-menu">\n      <div class="profile-menu-header">\n        <div class="profile-menu-name">${escapeHtml(e.userName)}</div>\n        <div class="profile-menu-email">${escapeHtml(e.email)}</div>\n      </div>\n      <a href="#/profile" class="profile-menu-item">${icon(Icons.USER,"icon")} Profile</a>\n      ${i}\n      <div class="profile-menu-divider"></div>\n      <a href="#/logout" class="profile-menu-item">${icon(Icons.LOG_OUT,"icon")} Logout</a>\n    </div>\n  `,n.insertBefore(o,n.lastChild)}function getUserInitials(e){if(!e)return"?";const n=e.split("@")[0].split(/[\s._-]+/).filter((e=>e.length>0));return n.length>=2?(n[0][0]+n[1][0]).toUpperCase():1===n.length&&n[0].length>=2?n[0].substring(0,2).toUpperCase():n[0][0].toUpperCase()}function escapeHtml(e){return e?e.replace(/[&<>"']/g,(e=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[e]))):""}function updateLanguageSelector(){const e=document.querySelector(".header-actions");if(!e)return;const n=e.querySelector(".language-selector");n&&n.remove();const t=getCurrentLanguage(),o=getSupportedLanguages(),s=document.createElement("div");s.className="language-selector";const i=o.map((e=>`\n      <button \n        class="language-menu-item" \n        data-lang="${e}"\n        type="button">\n        ${e.toUpperCase()}\n      </button>\n    `)).join("");s.innerHTML=`\n    <button class="language-btn" id="language-toggle" type="button" aria-label="Change language">\n      <div class="language-avatar" id="language-avatar-text">${t.toUpperCase()}</div>\n      ${icon(Icons.CHEVRON_DOWN,"icon icon-sm")}\n    </button>\n    <div class="profile-menu language-menu" id="language-menu">\n      ${i}\n    </div>\n  `;const a=e.querySelector("#theme-toggle");a?e.insertBefore(s,a):e.appendChild(s),s.hasAttribute("data-events-initialized")||(setupLanguageSelectorEvents(),s.setAttribute("data-events-initialized","true"))}function setupLanguageSelectorEvents(){document.addEventListener("click",(e=>{const n=e.target;if(n.closest("#language-toggle")){e.stopPropagation();const n=document.getElementById("language-menu");if(n){n.classList.toggle("show");const e=document.getElementById("profile-menu");e&&e.classList.remove("show")}return}const t=n.closest(".language-menu-item");if(t){e.stopPropagation();const n=t.getAttribute("data-lang");return void(n&&setLanguage(n).then((()=>{const e=document.getElementById("language-toggle");if(e){const t=e.querySelector("span");t&&(t.textContent=n.toUpperCase())}const t=document.getElementById("language-menu");t&&t.classList.remove("show");const o=location.hash;location.hash="",setTimeout((()=>{location.hash=o||"#/home"}),10)})))}const o=document.getElementById("language-menu");o&&!n.closest(".language-selector")&&o.classList.remove("show")})),onLanguageChange((e=>{if(document.getElementById("language-toggle")){const n=document.getElementById("language-avatar-text");n&&(n.textContent=e.toUpperCase())}}))}