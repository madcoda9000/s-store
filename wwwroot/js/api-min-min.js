let csrfToken=null,csrfTokenPromise=null;export function setCsrfToken(n){csrfToken=n}export function clearCsrfToken(){csrfToken=null,csrfTokenPromise=null}export async function initCsrfToken(){return csrfTokenPromise||(csrfToken?Promise.resolve():(csrfTokenPromise=(async()=>{try{const n=await fetch("/api/csrf-token",{method:"GET",credentials:"include"});if(n.ok){const e=await n.json();csrfToken=e.token}}catch(n){}finally{csrfTokenPromise=null}})(),csrfTokenPromise))}export async function api(n,{method:e="GET",body:o}={}){const r={Accept:"application/json"};"GET"!==e&&"HEAD"!==e&&(csrfToken||await initCsrfToken(),csrfToken&&(r["X-XSRF-TOKEN"]=csrfToken)),o&&(r["Content-Type"]="application/json",o=JSON.stringify(o));const s=await fetch(n,{method:e,headers:r,body:o,credentials:"include"});if(!s.ok){const t=(await safeJson(s))?.error||s.statusText;if(400===s.status&&t.includes("antiforgery")&&(clearCsrfToken(),await initCsrfToken(),csrfToken)){r["X-XSRF-TOKEN"]=csrfToken;const s=await fetch(n,{method:e,headers:r,body:o,credentials:"include"});if(s.ok)return safeJson(s);const t=await safeJson(s);throw new Error(t?.error||s.statusText)}throw new Error(t)}return safeJson(s)}async function safeJson(n){try{return await n.json()}catch{return null}}