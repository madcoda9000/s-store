import{api}from"../api.js";import{updateHeader}from"../header.js";import{icon,Icons}from"../icons.js";import{t}from"../i18n.js";import{hasRole,renderAccessDenied}from"../auth-utils.js";const state={currentPage:1,pageSize:10,sortBy:"timestamp",sortOrder:"desc",searchQuery:"",categoryFilter:"",fromDate:"",toDate:"",isInvestigator:!1,decryptedLogs:new Map};export function registerAuditLogs(e){e("/logs/audit",(async e=>{try{state.currentPage=1,state.pageSize=10,state.sortBy="timestamp",state.sortOrder="desc",state.searchQuery="",state.categoryFilter="",state.fromDate="",state.toDate="",state.decryptedLogs.clear();const n=await api("/auth/me");if(updateHeader(n),!hasRole(n,"Admin")&&!hasRole(n,"AuditInvestigator"))return void(e.innerHTML=renderAccessDenied(n,"/logs/audit","Admin",t("errors.adminAccessRequired")||"You need administrator privileges to access this page."));state.isInvestigator=hasRole(n,"AuditInvestigator"),e.innerHTML=renderView(null,!0),setupEventHandlers(e),updateClearButton(e),await loadLogs(e)}catch(t){const n=t;if(n.message.includes("Unauthorized")||n.message.includes("401"))return void(location.hash="/login");e.innerHTML=renderError(n.message)}}))}async function loadLogs(t){try{const e=t.querySelector("#logs-container");e&&(e.innerHTML='<div class="log-loading"><div class="spinner"></div><p>Loading logs...</p></div>'),updateFilterInputs(t);const n=new URLSearchParams({decrypt:"false",limit:"1000"});state.categoryFilter&&n.append("category",state.categoryFilter),state.fromDate&&n.append("fromDate",new Date(state.fromDate).toISOString()),state.toDate&&n.append("toDate",new Date(state.toDate).toISOString());let a=(await api(`/admin/audit?${n.toString()}`)).logs;if(state.searchQuery){const t=state.searchQuery.toLowerCase();a=a.filter((e=>e.action.toLowerCase().includes(t)||e.context.toLowerCase().includes(t)||e.message.toLowerCase().includes(t)||e.user.toLowerCase().includes(t)))}a=sortLogs(a,state.sortBy,state.sortOrder);const s=a.length,o=Math.ceil(s/state.pageSize),r=(state.currentPage-1)*state.pageSize,i=r+state.pageSize,c=a.slice(r,i);e&&(e.innerHTML=renderLogsTable({logs:c,pagination:{page:state.currentPage,size:state.pageSize,total:s,totalPages:o}}))}catch(e){const n=e,a=t.querySelector("#logs-container");a&&(a.innerHTML=`<div class="log-error"><div class="alert alert-danger">${escapeHtml(n.message)}</div></div>`)}}function updateFilterInputs(t){const e=t.querySelector("#log-search");e&&(e.value=state.searchQuery);const n=t.querySelector("#category-filter");n&&(n.value=state.categoryFilter);const a=t.querySelector("#from-date");a&&(a.value=state.fromDate);const s=t.querySelector("#to-date");s&&(s.value=state.toDate);const o=t.querySelector("#page-size");o&&(o.value=state.pageSize.toString()),updateClearButton(t)}function updateClearButton(t){const e=t.querySelector(".log-search-bar");if(!e)return;let n=e.querySelector("#clear-search-btn");state.searchQuery||state.categoryFilter||state.fromDate||state.toDate?n||(n=document.createElement("button"),n.id="clear-search-btn",n.className="btn btn-secondary",n.type="button",n.innerHTML=`${icon(Icons.X,"icon")} Clear Filters`,e.appendChild(n)):n&&n.remove()}function sortLogs(t,e,n){return[...t].sort(((t,a)=>{let s=t[e],o=a[e];return"timestamp"===e&&(s=new Date(s).getTime(),o=new Date(o).getTime()),"asc"===n?s>o?1:-1:s<o?1:-1}))}function renderView(t,e){return`\n    <div class="section">\n      <div class="section-header">\n        <h2 class="section-title mb-0">${icon(Icons.SHIELD,"icon")} Audit Logs</h2>\n      </div>\n\n      ${renderFilters()}\n\n      <div id="logs-container">\n        ${e?renderLoading():t?renderLogsTable(t):""}\n      </div>\n    </div>\n  `}function renderPseudonymSearch(){return`\n    <div class="card pseudonym-search-card">\n      <h3>${icon(Icons.SEARCH,"icon")} Search by Pseudonym</h3>\n      <p class="text-muted search-hint">\n        Search for all logs associated with a specific pseudonymized user identifier (e.g., "user_abc123")\n      </p>\n      <div class="pseudonym-search-flex">\n        <input\n          type="text"\n          id="pseudonym-search"\n          class="input"\n          placeholder="Enter pseudonym (e.g., user_abc123)"\n        />\n        <button id="pseudonym-search-btn" class="btn btn-primary" type="button">\n          ${icon(Icons.SEARCH,"icon")} Search\n        </button>\n      </div>\n    </div>\n  `}function renderFilters(){return`\n    <div class="log-search-bar">\n      <input\n        type="text"\n        id="log-search"\n        class="input"\n        placeholder="Search by action, context, message, or user..."\n        value="${escapeHtml(state.searchQuery)}"\n      />\n      <button id="search-btn" class="btn btn-primary" type="button">\n        ${icon(Icons.SEARCH,"icon")} Search\n      </button>\n    </div>\n\n    <div class="log-filters">\n      <div class="form-group">\n        <label for="category-filter" class="label">Category</label>\n        <select id="category-filter" class="select">\n          <option value="">All</option>\n          <option value="AUDIT" ${"AUDIT"===state.categoryFilter?"selected":""}>Audit</option>\n          <option value="ERROR" ${"ERROR"===state.categoryFilter?"selected":""}>Error</option>\n        </select>\n      </div>\n\n      <div class="form-group">\n        <label for="from-date" class="label">From Date</label>\n        <input\n          type="datetime-local"\n          id="from-date"\n          class="input"\n          value="${state.fromDate}"\n        />\n      </div>\n\n      <div class="form-group">\n        <label for="to-date" class="label">To Date</label>\n        <input\n          type="datetime-local"\n          id="to-date"\n          class="input"\n          value="${state.toDate}"\n        />\n      </div>\n\n      <div class="form-group">\n        <label class="label label-invisible">Apply</label>\n        <button id="apply-filters-btn" class="btn btn-primary" type="button">\n          Apply Filters\n        </button>\n      </div>\n    </div>\n\n    <div class="log-filters">\n      <div class="page-size-selector">\n        <label for="page-size">Show:</label>\n        <select id="page-size">\n          <option value="10" ${10===state.pageSize?"selected":""}>10</option>\n          <option value="30" ${30===state.pageSize?"selected":""}>30</option>\n          <option value="50" ${50===state.pageSize?"selected":""}>50</option>\n          <option value="100" ${100===state.pageSize?"selected":""}>100</option>\n        </select>\n        <span>per page</span>\n      </div>\n    </div>\n  `}function renderLogsTable(t){return t.logs&&0!==t.logs.length?`\n    <div class="log-table-container">\n      <table class="log-table">\n        <thead>\n          <tr>\n            <th class="sortable ${"timestamp"===state.sortBy?"sort-"+state.sortOrder:""}" data-sort="timestamp">\n              Timestamp\n            </th>\n            <th class="sortable ${"category"===state.sortBy?"sort-"+state.sortOrder:""}" data-sort="category">\n              Category\n            </th>\n            <th class="sortable ${"user"===state.sortBy?"sort-"+state.sortOrder:""}" data-sort="user">\n              User\n            </th>\n            <th class="sortable ${"action"===state.sortBy?"sort-"+state.sortOrder:""}" data-sort="action">\n              Action\n            </th>\n            <th class="sortable hide-mobile ${"context"===state.sortBy?"sort-"+state.sortOrder:""}" data-sort="context">\n              Context\n            </th>\n            <th>Message</th>\n            ${state.isInvestigator?"<th>Actions</th>":""}\n          </tr>\n        </thead>\n        <tbody>\n          ${t.logs.map((t=>renderLogRow(t))).join("")}\n        </tbody>\n      </table>\n    </div>\n\n    ${renderPagination(t.pagination)}\n  `:`\n      <div class="log-empty-state">\n        ${icon(Icons.SHIELD,"icon")}\n        <p>No audit logs found</p>\n      </div>\n    `}function renderLogRow(t){const e=state.decryptedLogs.get(t.id),n="ERROR"===t.category?"badge-danger":"badge-primary";return`\n    <tr>\n      <td class="log-cell-timestamp">${formatTimestamp(t.timestamp)}</td>\n      <td><span class="badge ${n}">${escapeHtml(t.category)}</span></td>\n      <td class="log-cell-user">\n        ${e?`<span class="user-decrypted">${escapeHtml(e)}</span><br><span class="user-pseudonym-small text-muted">${escapeHtml(t.user)}</span>`:escapeHtml(t.user)}\n      </td>\n      <td class="log-cell-action">${escapeHtml(t.action)}</td>\n      <td class="log-cell-context hide-mobile">${escapeHtml(t.context)}</td>\n      <td class="log-cell-message">${escapeHtml(t.message)}</td>\n      ${state.isInvestigator?`<td>\n            ${t.hasEncryptedInfo?`<button class="btn btn-sm btn-warning decrypt-btn" data-log-id="${t.id}" data-log-action="${escapeHtml(t.action)}" data-log-timestamp="${escapeHtml(t.timestamp)}" data-log-user="${escapeHtml(t.user)}">\n                  ${icon(Icons.UNLOCK,"icon")} Decrypt\n                </button>`:'<span class="text-muted no-encrypted-data">No encrypted data</span>'}\n          </td>`:""}\n    </tr>\n  `}function renderPagination(t){if(!t||t.totalPages<=1)return"";const{page:e,totalPages:n,total:a}=t,s=(e-1)*state.pageSize+1,o=Math.min(e*state.pageSize,a),r=[];if(n<=7)for(let t=1;t<=n;t++)r.push(t);else if(e<=4){for(let t=1;t<=5;t++)r.push(t);r.push("..."),r.push(n)}else if(e>=n-3){r.push(1),r.push("...");for(let t=n-4;t<=n;t++)r.push(t)}else{r.push(1),r.push("...");for(let t=e-1;t<=e+1;t++)r.push(t);r.push("..."),r.push(n)}return`\n    <div class="pagination">\n      <div class="pagination-info">\n        Showing ${s} to ${o} of ${a} logs\n      </div>\n\n      <div class="pagination-controls">\n        <button\n          class="pagination-btn"\n          data-page="${e-1}"\n          ${1===e?"disabled":""}\n        >\n          ${icon(Icons.CHEVRON_LEFT,"icon")}\n        </button>\n\n        ${r.map((t=>"..."===t?'<span class="pagination-ellipsis">...</span>':`\n            <button\n              class="pagination-btn ${t===e?"active":""} ${Math.abs(t-e)>2?"hide-mobile":""}"\n              data-page="${t}"\n              ${t===e?"disabled":""}\n            >\n              ${t}\n            </button>\n          `)).join("")}\n\n        <button\n          class="pagination-btn"\n          data-page="${e+1}"\n          ${e===n?"disabled":""}\n        >\n          ${icon(Icons.CHEVRON_RIGHT,"icon")}\n        </button>\n      </div>\n    </div>\n  `}function renderLoading(){return'\n    <div class="log-loading">\n      <div class="spinner"></div>\n      <p>Loading audit logs...</p>\n    </div>\n  '}function renderError(t){return`\n    <div class="section">\n      <div class="log-error">\n        <div class="alert alert-danger">\n          <strong>Error:</strong> ${escapeHtml(t)}\n        </div>\n      </div>\n    </div>\n  `}function openDecryptModal(t,e,n,a){const s=document.createElement("div");s.className="modal",s.innerHTML=`\n    <div class="modal-overlay"></div>\n    <div class="modal-content modal-content-wide">\n      <div class="modal-header">\n        <h3>${icon(Icons.UNLOCK,"icon")} Decrypt User Information</h3>\n        <button class="modal-close" aria-label="Close">\n          ${icon(Icons.X,"icon")}\n        </button>\n      </div>\n      <div class="modal-body">\n        <div class="alert alert-warning">\n          <strong>Warning:</strong> Decrypting user information is a privileged operation that will be logged.\n          Please provide a valid justification for accessing this data.\n        </div>\n\n        <div class="decrypt-log-details">\n          <p><strong>Log ID:</strong> ${t}</p>\n          <p><strong>Action:</strong> ${escapeHtml(e)}</p>\n          <p><strong>Timestamp:</strong> ${formatTimestamp(n)}</p>\n          <p><strong>Pseudonym:</strong> <code>${escapeHtml(a)}</code></p>\n        </div>\n\n        <form id="decrypt-form">\n          <div class="form-group">\n            <label for="justification" class="label">\n              Justification <span class="decrypt-required-star">*</span>\n            </label>\n            <textarea\n              id="justification"\n              class="textarea"\n              required\n              minlength="10"\n              maxlength="500"\n              placeholder="Enter a detailed justification for decrypting this log entry (minimum 10 characters)..."\n            ></textarea>\n            <p class="form-hint">Minimum 10 characters, maximum 500 characters</p>\n          </div>\n\n          <div class="button-group">\n            <button type="submit" class="btn btn-warning">\n              ${icon(Icons.UNLOCK,"icon")} Decrypt User Information\n            </button>\n            <button type="button" class="btn btn-secondary modal-cancel">\n              Cancel\n            </button>\n          </div>\n\n          <div id="decrypt-result"></div>\n        </form>\n      </div>\n    </div>\n  `,document.body.appendChild(s);const o=s.querySelector(".modal-close"),r=s.querySelector(".modal-cancel"),i=s.querySelector(".modal-overlay"),c=s.querySelector("#decrypt-form"),l=s.querySelector("#decrypt-result"),d=t=>{t?.stopPropagation(),s.remove()};o?.addEventListener("click",d),r?.addEventListener("click",d),i?.addEventListener("click",(t=>{t.target===i&&d(t)})),c.addEventListener("submit",(async e=>{e.preventDefault();const n=c.querySelector("#justification").value.trim();if(!n||n.length<10)return void(l&&(l.innerHTML='<div class="alert alert-danger">Justification must be at least 10 characters long.</div>'));const a=c.querySelector('button[type="submit"]');a&&(a.disabled=!0,a.innerHTML='<div class="spinner spinner-sm"></div> Decrypting...');try{const e=await api("/admin/audit/decrypt",{method:"POST",body:{logId:t,justification:n}});state.decryptedLogs.set(t,e.decryptedUser);const a=s.querySelector(".modal-body");if(a){a.innerHTML=`\n          <div class="alert alert-success">\n            <strong>Decryption Successful</strong>\n          </div>\n          \n          <div class="decrypt-user-display">\n            <p><strong>Decrypted User:</strong></p>\n            <p class="decrypt-user-name">${escapeHtml(e.decryptedUser)}</p>\n          </div>\n\n          <div class="decrypt-meta-info">\n            <p><strong>Decrypted by:</strong> ${escapeHtml(e.decryptedBy)}</p>\n            <p><strong>Decrypted at:</strong> ${new Date(e.decryptedAt).toLocaleString()}</p>\n            <p><strong>Justification:</strong> ${escapeHtml(e.justification)}</p>\n          </div>\n\n          <button type="button" class="btn btn-primary modal-close-success">\n            Close\n          </button>\n        `;a.querySelector(".modal-close-success")?.addEventListener("click",(()=>{d();const t=document.querySelector("#app");t&&loadLogs(t)}))}}catch(t){const e=t;l&&(l.innerHTML=`<div class="alert alert-danger"><strong>Decryption Failed:</strong> ${escapeHtml(e.message)}</div>`),a&&(a.disabled=!1,a.innerHTML=`${icon(Icons.UNLOCK,"icon")} Decrypt User Information`)}}))}async function searchByPseudonym(t,e){try{const n=e.querySelector("#logs-container");n&&(n.innerHTML='<div class="log-loading"><div class="spinner"></div><p>Searching by pseudonym...</p></div>');let a=sortLogs((await api(`/admin/audit/by-pseudonym/${encodeURIComponent(t)}`)).logs,state.sortBy,state.sortOrder);const s=a.length,o=Math.ceil(s/state.pageSize),r=(state.currentPage-1)*state.pageSize,i=r+state.pageSize,c=a.slice(r,i);n&&(n.innerHTML=`\n        <div class="alert alert-info mb-25">\n          Found ${s} log(s) for pseudonym: <code>${escapeHtml(t)}</code>\n          <button id="clear-pseudonym-search" class="btn btn-sm btn-secondary ml-10">\n            Show All Logs\n          </button>\n        </div>\n        ${renderLogsTable({logs:c,pagination:{page:state.currentPage,size:state.pageSize,total:s,totalPages:o}})}\n      `)}catch(t){const n=t,a=e.querySelector("#logs-container");a&&(a.innerHTML=`<div class="log-error"><div class="alert alert-danger">${escapeHtml(n.message)}</div></div>`)}}function setupEventHandlers(t){t.addEventListener("click",(function(e){const n=e.target;if(n.closest("#search-btn")){const e=t.querySelector("#log-search");return void(e&&(state.searchQuery=e.value.trim(),state.currentPage=1,loadLogs(t)))}if(n.closest("#apply-filters-btn")){const e=t.querySelector("#from-date"),n=t.querySelector("#to-date");return e&&(state.fromDate=e.value),n&&(state.toDate=n.value),state.currentPage=1,void loadLogs(t)}if(n.closest("#clear-search-btn"))return state.searchQuery="",state.categoryFilter="",state.fromDate="",state.toDate="",state.currentPage=1,void loadLogs(t);const a=n.closest(".decrypt-btn");if(a){const t=parseInt(a.getAttribute("data-log-id")||"0"),e=a.getAttribute("data-log-action")||"",n=a.getAttribute("data-log-timestamp")||"",s=a.getAttribute("data-log-user")||"";return void(t&&openDecryptModal(t,e,n,s))}const s=n.closest(".pagination-btn[data-page]");if(s&&!s.hasAttribute("disabled")){const e=parseInt(s.getAttribute("data-page")||"1");return state.currentPage=e,void loadLogs(t)}const o=n.closest(".sortable[data-sort]");if(o){const e=o.getAttribute("data-sort")||"timestamp";return state.sortBy===e?state.sortOrder="asc"===state.sortOrder?"desc":"asc":(state.sortBy=e,state.sortOrder="desc"),void loadLogs(t)}}));const e=t.querySelector("#log-search");e&&e.addEventListener("keypress",(n=>{"Enter"===n.key&&(state.searchQuery=e.value.trim(),state.currentPage=1,loadLogs(t))}));const n=t.querySelector("#page-size");n&&n.addEventListener("change",(()=>{state.pageSize=parseInt(n.value),state.currentPage=1,loadLogs(t)}));const a=t.querySelector("#category-filter");a&&a.addEventListener("change",(()=>{state.categoryFilter=a.value,state.currentPage=1,loadLogs(t)}))}function formatTimestamp(t){const e=new Date(t),n=(new Date).getTime()-e.getTime(),a=Math.floor(n/6e4);return a<1?"Just now":a<60?`${a}m ago`:a<1440?`${Math.floor(a/60)}h ago`:e.toLocaleString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}function escapeHtml(t){if(!t)return"";const e=document.createElement("div");return e.textContent=t,e.innerHTML}