import{api,setCsrfToken}from"../api.js";import{hideHeader,updateHeader}from"../header.js";import{icon,Icons}from"../icons.js";import{t}from"../i18n.js";export function registerSetup2fa(t){t("/setup-2fa",(async t=>{try{const e=await api("/auth/me"),n=1===e.twoFactorEnforced;n?hideHeader():updateHeader(e);const a={currentStep:"selection",mode:n?"enforced":"optional",selectedMethod:null,qrCodeUrl:null,manualKey:null,codeSent:!1,recoveryCodes:null};await renderStep(t,a)}catch(e){const n=e;if(n.message.includes("Unauthorized")||n.message.includes("401"))return void(location.hash="/login");t.innerHTML=renderError(n.message)}}))}async function renderStep(t,e){switch(e.currentStep){case"selection":renderMethodSelection(t,e);break;case"authenticator":renderAuthenticatorSetup(t,e);break;case"email":await renderEmailSetup(t,e);break;case"recovery":renderRecoveryCodes(t,e);break;case"success":renderSuccess(t,e);break}}function renderMethodSelection(e,n){const a="enforced"===n.mode;e.innerHTML=a?`\n      <div class="auth-container">\n        <div class="auth-wrapper">\n          <div class="card auth-card shadow-lg">\n            <div class="auth-header">\n              <h2>${t("auth.setup2fa.title")}</h2>\n              <p">\n              <div class="alert alert-info">  \n                ${t("auth.setup2fa.enforcedNotice")}\n              </div>\n              </p>\n            </div>\n            \n            <div class="mb-25">\n              <p class="text-muted">${t("auth.setup2fa.description")}</p>\n            </div>\n            \n            <h4 class="mb-25">${t("auth.setup2fa.chooseMethod")}</h4>\n            \n            \x3c!-- Authenticator Method --\x3e\n            <div class="card mb-25">\n              <h4 class="mb-10">\n                ${icon(Icons.SHIELD_CHECK,"icon icon-lg mr-5")}\n                ${t("auth.setup2fa.authenticatorMethod.title")}\n                <span class="badge badge-success ml-10">${t("auth.setup2fa.authenticatorMethod.recommended")}</span>\n              </h4>              \n              <p class="text-muted mb-10">${t("auth.setup2fa.authenticatorMethod.description")}</p>\n              <button type="button" class="btn btn-primary btn-block" data-select-method="authenticator">\n                ${t("auth.setup2fa.authenticatorMethod.selectButton")}\n              </button>\n            </div>\n            \n            \x3c!-- Email Method --\x3e\n            <div class="card">\n              <h4 class="mb-10">\n                ${icon(Icons.MAIL,"icon icon-lg mr-5")}\n                ${t("auth.setup2fa.emailMethod.title")}\n                <span class="badge badge-warning ml-10">${t("auth.setup2fa.authenticatorMethod.notRecommended")}</span>\n              </h4>\n              <p class="text-muted mb-10">${t("auth.setup2fa.emailMethod.description")}</p>\n              <button type="button" class="btn btn-warning btn-block" data-select-method="email">\n                ${t("auth.setup2fa.emailMethod.selectButton")}\n              </button>\n            </div>\n          </div>\n        </div>\n      </div>\n    `:`\n      <div class="section">\n        <div class="section-header">\n          <h2 class="section-title mb-0">${t("auth.setup2fa.title")}</h2>\n        </div>\n        \n        <p class="text-muted mb-25">${t("auth.setup2fa.description")}</p>\n        \n        <h4 class="mt-25 mb-25">${t("auth.setup2fa.chooseMethod")}</h4>\n        \n        <div class="grid">\n          \x3c!-- Authenticator Method --\x3e\n          <div class="card">\n            <h4>\n              ${icon(Icons.SHIELD_CHECK,"icon icon-lg mr-5")}\n              ${t("auth.setup2fa.authenticatorMethod.title")}\n              <span class="badge badge-success ml-10">${t("auth.setup2fa.authenticatorMethod.recommended")}</span>\n            </h4>            \n            <p class="text-muted mb-25">${t("auth.setup2fa.authenticatorMethod.description")}</p>\n            <button type="button" class="btn btn-primary btn-block" data-select-method="authenticator">\n              ${t("auth.setup2fa.authenticatorMethod.selectButton")}\n            </button>\n          </div>\n          \n          \x3c!-- Email Method --\x3e\n          <div class="card">\n            <h4>\n              ${icon(Icons.MAIL,"icon icon-lg mr-5")}\n              ${t("auth.setup2fa.emailMethod.title")}\n              <span class="badge badge-warning ml-10">${t("auth.setup2fa.authenticatorMethod.notRecommended")}</span>\n            </h4>\n            <p class="text-muted mb-25">${t("auth.setup2fa.emailMethod.description")}</p>\n            <button type="button" class="btn btn-warning btn-block" data-select-method="email">\n              ${t("auth.setup2fa.emailMethod.selectButton")}\n            </button>\n          </div>\n        </div>\n      </div>\n    `,e.querySelectorAll("[data-select-method]").forEach((t=>{t.addEventListener("click",(async t=>{const a=t.target.closest("button")?.getAttribute("data-select-method");"authenticator"===a?(n.selectedMethod="Authenticator",n.currentStep="authenticator",await initAuthenticatorSetup(e,n)):"email"===a&&(n.selectedMethod="Email",n.currentStep="email",await renderStep(e,n))}))}))}async function initAuthenticatorSetup(e,n){try{const t=await api("/auth/2fa/setup-authenticator",{method:"POST"});t.csrfToken&&setCsrfToken(t.csrfToken),n.qrCodeUrl=t.otpauth,n.manualKey=t.key,await renderStep(e,n)}catch(a){alert(a.message||t("auth.setup2fa.errors.setupFailed")),n.currentStep="selection",await renderStep(e,n)}}function renderAuthenticatorSetup(e,n){const a="optional"===n.mode,s="enforced"===n.mode?"auth-container":"container";e.innerHTML=`\n    <div class="${s}">\n      <div class="auth-wrapper">\n        <div class="card auth-card shadow-lg">\n          <div class="auth-header">\n            <h2>${t("auth.setup2fa.authenticatorSetup.title")}</h2>\n          </div>\n          \n          \x3c!-- Step 1: QR Code --\x3e\n          <div class="mb-25">\n            <h4 class="mb-10">${t("auth.setup2fa.authenticatorSetup.step1")}</h4>\n            <p class="text-muted mb-25">${t("auth.setup2fa.authenticatorSetup.step1Description")}</p>\n            \n            <div class="text-center mb-25">\n              <div id="qr-code" class="card d-inline-block p-25"></div>\n            </div>\n            \n            <p class="text-muted mb-10">${t("auth.setup2fa.authenticatorSetup.step1Alt")}</p>\n            <div class="form-group">\n              <div class="input-with-actions">\n                <input \n                  type="text" \n                  id="manual-key" \n                  class="input" \n                  value="${escapeHtml(n.manualKey||"")}" \n                  readonly\n                />\n                <button type="button" class="input-action-btn" id="copy-key-btn" aria-label="${t("auth.setup2fa.authenticatorSetup.copyKey")}">\n                  ${icon(Icons.COPY)}\n                </button>\n              </div>\n            </div>\n          </div>\n          \n          \x3c!-- Step 2: Verify --\x3e\n          <div>\n            <h4 class="mb-10">${t("auth.setup2fa.authenticatorSetup.step2")}</h4>\n            <p class="text-muted mb-25">${t("auth.setup2fa.authenticatorSetup.step2Description")}</p>\n            \n            <form id="verify-authenticator-form" class="form">\n              <div class="form-group">\n                <label class="label" for="code">${t("auth.setup2fa.authenticatorSetup.code")}</label>\n                <input \n                  type="text" \n                  id="code" \n                  name="code"\n                  class="input" \n                  placeholder="${t("auth.setup2fa.authenticatorSetup.codePlaceholder")}"\n                  maxlength="6"\n                  pattern="[0-9]{6}"\n                  inputmode="numeric"\n                  autocomplete="one-time-code"\n                  required\n                />\n              </div>\n              \n              <div id="verify-error" class="error hidden"></div>\n              \n              <div class="button-group">\n                ${a?`\n                  <button type="button" class="btn btn-secondary" id="back-btn">\n                    ${icon(Icons.ARROW_LEFT,"icon")} ${t("auth.setup2fa.authenticatorSetup.backButton")}\n                  </button>\n                `:""}\n                <button type="submit" class="btn btn-primary flex-1">\n                  ${t("auth.setup2fa.authenticatorSetup.verifyButton")}\n                </button>\n              </div>\n            </form>\n          </div>\n        </div>\n      </div>\n    </div>\n  `;const o=e.querySelector("#qr-code");if(o&&n.qrCodeUrl){const t=document.createElement("img");t.src=`https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(n.qrCodeUrl)}`,t.alt="QR Code",t.style.maxWidth="200px",o.appendChild(t)}const c=e.querySelector("#copy-key-btn");if(c&&c.addEventListener("click",(async()=>{const t=e.querySelector("#manual-key");if(t)try{await navigator.clipboard.writeText(t.value),c.innerHTML=icon(Icons.CHECK),setTimeout((()=>{c.innerHTML=icon(Icons.COPY)}),2e3)}catch{t.select(),document.execCommand("copy")}})),a){const t=e.querySelector("#back-btn");t&&t.addEventListener("click",(async()=>{n.currentStep="selection",n.selectedMethod=null,n.qrCodeUrl=null,n.manualKey=null,await renderStep(e,n)}))}const r=e.querySelector("#verify-authenticator-form"),i=e.querySelector("#verify-error");r.addEventListener("submit",(async a=>{a.preventDefault(),i.classList.add("hidden");const s=new FormData(r).get("code")?.toString()||"",o=r.querySelector('button[type="submit"]'),c=o.innerHTML;o.disabled=!0,o.innerHTML=t("auth.setup2fa.authenticatorSetup.verifying");try{const t=await api("/auth/2fa/verify-authenticator-setup",{method:"POST",body:{Code:s}});t.csrfToken&&setCsrfToken(t.csrfToken),n.recoveryCodes=t.recoveryCodes,n.currentStep="recovery",await renderStep(e,n)}catch(e){const n=e;i.textContent=n.message||t("auth.setup2fa.errors.invalidCode"),i.classList.remove("hidden"),o.disabled=!1,o.innerHTML=c}}))}async function renderEmailSetup(e,n){const a="optional"===n.mode,s="enforced"===n.mode?"auth-container":"container";let o="";try{o=(await api("/auth/me")).email||""}catch{o=""}if(e.innerHTML=`\n    <div class="${s}">\n      <div class="auth-wrapper">\n        <div class="card auth-card shadow-lg">\n          <div class="auth-header">\n            <h2>${t("auth.setup2fa.emailSetup.title")}</h2>\n          </div>\n          \n          ${n.codeSent?`\n            \x3c!-- Step 2: Verify Code --\x3e\n            <div>\n              <div class="alert alert-success mb-25">\n                ${icon(Icons.MAIL,"icon")} ${t("auth.setup2fa.emailSetup.codeSent")}\n              </div>\n              \n              <h4 class="mb-10">${t("auth.setup2fa.emailSetup.step2")}</h4>\n              <p class="text-muted mb-25">${t("auth.setup2fa.emailSetup.step2Description")}</p>\n              \n              <form id="verify-email-form" class="form">\n                <div class="form-group">\n                  <label class="label" for="code">${t("auth.setup2fa.emailSetup.code")}</label>\n                  <input \n                    type="text" \n                    id="code" \n                    name="code"\n                    class="input" \n                    placeholder="${t("auth.setup2fa.emailSetup.codePlaceholder")}"\n                    maxlength="6"\n                    pattern="[0-9]{6}"\n                    inputmode="numeric"\n                    autocomplete="one-time-code"\n                    required\n                  />\n                </div>\n                \n                <div id="verify-error" class="error hidden"></div>\n                \n                <div class="button-group">\n                  <button type="button" class="btn btn-secondary" id="resend-btn">\n                    ${icon(Icons.REFRESH_CW,"icon")} ${t("auth.setup2fa.emailSetup.resendButton")}\n                  </button>\n                  <button type="submit" class="btn btn-primary flex-1">\n                    ${t("auth.setup2fa.emailSetup.verifyButton")}\n                  </button>\n                </div>\n              </form>\n            </div>\n          `:`\n            \x3c!-- Step 1: Request Code --\x3e\n            <div>\n              <h4 class="mb-10">${t("auth.setup2fa.emailSetup.step1")}</h4>\n              <p class="text-muted mb-25">${t("auth.setup2fa.emailSetup.step1Description")}</p>\n              \n              <div class="form-group">\n                <input \n                  type="email" \n                  class="input" \n                  value="${escapeHtml(o)}" \n                  disabled\n                />\n              </div>\n              \n              <div id="send-error" class="error hidden"></div>\n              \n              <div class="button-group">\n                ${a?`\n                  <button type="button" class="btn btn-secondary" id="back-btn">\n                    ${icon(Icons.ARROW_LEFT,"icon")} ${t("auth.setup2fa.emailSetup.backButton")}\n                  </button>\n                `:""}\n                <button type="button" class="btn btn-primary flex-1 mt-25" id="send-code-btn">\n                  ${t("auth.setup2fa.emailSetup.sendCodeButton")}\n                </button>\n              </div>\n            </div>\n          `}\n        </div>\n      </div>\n    </div>\n  `,!n.codeSent&&a){const t=e.querySelector("#back-btn");t&&t.addEventListener("click",(async()=>{n.currentStep="selection",n.selectedMethod=null,n.codeSent=!1,await renderStep(e,n)}))}const c=e.querySelector("#send-code-btn");c&&c.addEventListener("click",(async()=>{const a=e.querySelector("#send-error");a.classList.add("hidden");const s=c,o=s.innerHTML;s.disabled=!0,s.innerHTML=t("auth.setup2fa.emailSetup.sending");try{const t=await api("/auth/2fa/setup-email",{method:"POST"});t.csrfToken&&setCsrfToken(t.csrfToken),n.codeSent=!0,await renderStep(e,n)}catch(e){const n=e;a.textContent=n.message||t("auth.setup2fa.errors.emailSendFailed"),a.classList.remove("hidden"),s.disabled=!1,s.innerHTML=o}}));const r=e.querySelector("#resend-btn");r&&r.addEventListener("click",(async()=>{const e=r,n=e.innerHTML;e.disabled=!0,e.innerHTML=t("auth.setup2fa.emailSetup.sending");try{const a=await api("/auth/2fa/setup-email",{method:"POST"});a.csrfToken&&setCsrfToken(a.csrfToken),e.innerHTML=`${icon(Icons.CHECK,"icon")} ${t("auth.setup2fa.emailSetup.codeSent")}`,setTimeout((()=>{e.disabled=!1,e.innerHTML=n}),3e3)}catch{e.disabled=!1,e.innerHTML=n}}));const i=e.querySelector("#verify-email-form");if(i){const a=e.querySelector("#verify-error");i.addEventListener("submit",(async s=>{s.preventDefault(),a.classList.add("hidden");const o=new FormData(i).get("code")?.toString()||"",c=i.querySelector('button[type="submit"]'),r=c.innerHTML;c.disabled=!0,c.innerHTML=t("auth.setup2fa.emailSetup.verifying");try{const t=await api("/auth/2fa/verify-email-setup",{method:"POST",body:{Code:o}});t.csrfToken&&setCsrfToken(t.csrfToken),n.recoveryCodes=t.recoveryCodes,n.currentStep="recovery",await renderStep(e,n)}catch(e){const n=e;a.textContent=n.message||t("auth.setup2fa.errors.invalidCode"),a.classList.remove("hidden"),c.disabled=!1,c.innerHTML=r}}))}}function renderRecoveryCodes(e,n){const a=(n.recoveryCodes||[]).join("\n"),s="enforced"===n.mode?"auth-container":"container";e.innerHTML=`\n    <div class="${s}">\n      <div class="auth-wrapper">\n        <div class="card auth-card shadow-lg">\n          <div class="auth-header">\n            <h2>${t("auth.setup2fa.recoveryCodes.title")}</h2>\n          </div>\n          \n          <div class="alert alert-warning mb-25">\n            ${icon(Icons.ALERT_TRIANGLE,"icon")} <strong>${t("auth.setup2fa.recoveryCodes.warning")}</strong>\n          </div>\n          \n          <p class="text-muted mb-25">${t("auth.setup2fa.recoveryCodes.description")}</p>\n          \n          <div class="card mb-25">\n            <pre class="code-block">${escapeHtml(a)}</pre>\n          </div>\n          \n          <div class="button-group mb-25">\n            <button type="button" class="btn btn-secondary" id="copy-codes-btn">\n              ${icon(Icons.COPY,"icon")} ${t("auth.setup2fa.recoveryCodes.copyButton")}\n            </button>\n            <button type="button" class="btn btn-secondary" id="download-codes-btn">\n              ${icon(Icons.DOWNLOAD,"icon")} ${t("auth.setup2fa.recoveryCodes.downloadButton")}\n            </button>\n            <button type="button" class="btn btn-secondary" id="print-codes-btn">\n              ${icon(Icons.PRINTER,"icon")} ${t("auth.setup2fa.recoveryCodes.printButton")}\n            </button>\n          </div>\n          \n          <button type="button" class="btn btn-primary btn-block" id="confirm-btn">\n            ${t("auth.setup2fa.recoveryCodes.confirmButton")}\n          </button>\n        </div>\n      </div>\n    </div>\n  `;const o=e.querySelector("#copy-codes-btn");o&&o.addEventListener("click",(async()=>{try{await navigator.clipboard.writeText(a),o.innerHTML=`${icon(Icons.CHECK,"icon")} ${t("auth.setup2fa.recoveryCodes.copied")}`,setTimeout((()=>{o.innerHTML=`${icon(Icons.COPY,"icon")} ${t("auth.setup2fa.recoveryCodes.copyButton")}`}),2e3)}catch(t){}}));const c=e.querySelector("#download-codes-btn");c&&c.addEventListener("click",(()=>{const t=new Blob([a],{type:"text/plain"}),e=URL.createObjectURL(t),n=document.createElement("a");n.href=e,n.download=`s-store-recovery-codes-${(new Date).toISOString().split("T")[0]}.txt`,n.click(),URL.revokeObjectURL(e)}));const r=e.querySelector("#print-codes-btn");r&&r.addEventListener("click",(()=>{const t=window.open("","","width=600,height=400");t&&(t.document.write(`\n          <html>\n            <head>\n              <title>S-Store Recovery Codes</title>\n              <style>\n                body { font-family: monospace; padding: 2rem; }\n                h1 { font-size: 1.5rem; margin-bottom: 1rem; }\n                pre { white-space: pre-wrap; word-break: break-all; }\n              </style>\n            </head>\n            <body>\n              <h1>S-Store Recovery Codes</h1>\n              <p>Keep these codes in a safe place!</p>\n              <pre>${escapeHtml(a)}</pre>\n            </body>\n          </html>\n        `),t.document.close(),t.print())}));const i=e.querySelector("#confirm-btn");i&&i.addEventListener("click",(async()=>{n.currentStep="success",await renderStep(e,n)}))}function renderSuccess(e,n){const a="enforced"===n.mode?"auth-container":"container";e.innerHTML=`\n    <div class="${a}">\n      <div class="auth-wrapper">\n        <div class="card auth-card shadow-lg text-center">\n          <div class="mb-25 text-success">\n            ${icon(Icons.CHECK_CIRCLE,"icon icon-xl")}\n          </div>\n          \n          <h2 class="mb-10">${t("auth.setup2fa.success.title")}</h2>\n          <p class="text-muted mb-25">${t("auth.setup2fa.success.description")}</p>\n          \n          <div class="card mb-25">\n            <strong>${t("auth.setup2fa.success.methodEnabled").replace("{{method}}",n.selectedMethod||"")}</strong>\n          </div>\n          \n          <button type="button" class="btn btn-primary btn-block" id="continue-btn">\n            ${t("auth.setup2fa.success.continueButton")}\n          </button>\n        </div>\n      </div>\n    </div>\n  `;const s=e.querySelector("#continue-btn");s&&s.addEventListener("click",(()=>{location.hash="/home"}))}function renderError(e){return`\n    <div class="section">\n      <div class="alert alert-danger">\n        <strong>${t("errors.generic")}</strong> ${escapeHtml(e)}\n      </div>\n    </div>\n  `}function escapeHtml(t){return t?t.replace(/[&<>"']/g,(t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[t]))):""}