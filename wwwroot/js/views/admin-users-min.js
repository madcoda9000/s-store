import{api,setCsrfToken}from"../api.js";import{updateHeader}from"../header.js";import{hasRole,renderAccessDenied}from"../auth-utils.js";import{t}from"../i18n.js";export function registerAdminUsers(e){e("/admin/users",(async e=>{try{const n=await api("/auth/me");if(updateHeader(n),!hasRole(n,"Admin"))return void(e.innerHTML=renderAccessDenied(n,"/admin/users","Admin",t("errors.adminAccessRequired")||"You need administrator privileges to access this page."));const s=await api("/admin/users");e.innerHTML=`\n        <div class="section">\n          <div class="section-header">\n            <h2 class="section-title mb-0">Users</h2>\n            <button class="btn btn-primary" id="add-user-btn">Add User</button>\n          </div>\n          \n          <div class="card">\n            <div class="table-container">\n              <table class="table">\n                <thead>\n                  <tr>\n                    <th>Username</th>\n                    <th>Email</th>\n                    <th>2FA</th>\n                    <th>Account Status</th>\n                    <th>2fa Enforced</th>\n                    <th>Actions</th>\n                  </tr>\n                </thead>\n                <tbody>\n                  ${s.map((e=>renderUserRow(e))).join("")}\n                </tbody>\n              </table>\n            </div>\n          </div>\n          \n          <div id="message" class="alert alert-success hidden"></div>\n        </div>`,e.addEventListener("click",(async t=>{const n=t.target.closest("button[data-action]");if(!n)return;const s=n.getAttribute("data-action"),a=n.getAttribute("data-method"),r=n.getAttribute("data-id"),d=e.querySelector("#message");if(!r||!d)return;const c={enable:`/admin/users/${r}/enable`,disable:`/admin/users/${r}/disable`,enforce2fa:`/admin/users/${r}/enforce-2fa`,unenforce2fa:`/admin/users/${r}/unenforce-2fa`,delete:`/admin/users/${r}/delete`};try{const e=await api(c[s],{method:a});d.textContent="Action completed successfully!",d.className="alert alert-success",d.classList.remove("hidden"),e?.csrfToken&&setCsrfToken(e.csrfToken),setTimeout((()=>{location.reload()}),1e3)}catch(e){const t=e;d.textContent=t.message||"An error occurred",d.className="alert alert-danger",d.classList.remove("hidden")}})),e.addEventListener("change",(async t=>{const n=t.target;if("checkbox"!==n.type)return;const s=n.getAttribute("data-action"),a=n.getAttribute("data-id"),r=e.querySelector("#message");if(!a||!r||!s)return;let d="";if("toggle-status"===s){n.getAttribute("data-current-status");d=n.checked?`/admin/users/${a}/enable`:`/admin/users/${a}/disable`}else if("toggle-2fa-enforce"===s){n.getAttribute("data-current-2fa");d=n.checked?`/admin/users/${a}/enforce-2fa`:`/admin/users/${a}/unenforce-2fa`}if(d){n.disabled=!0;try{const e=await api(d,{method:"PUT"});r.textContent="Action completed successfully!",r.className="alert alert-success",r.classList.remove("hidden"),e?.csrfToken&&setCsrfToken(e.csrfToken),setTimeout((()=>{location.reload()}),1e3)}catch(e){const t=e;r.textContent=t.message||"An error occurred",r.className="alert alert-danger",r.classList.remove("hidden"),n.checked=!n.checked,n.disabled=!1}}}))}catch(t){const n=t;if(n.message.includes("Unauthorized")||n.message.includes("401")||n.message.includes("403"))return void(location.hash="/login");e.innerHTML=`\n        <div class="section">\n          <div class="alert alert-danger">\n            <strong>Error:</strong> ${escapeHtml(n.message||"Failed to load users")}\n          </div>\n        </div>`}}))}function renderUserRow(e){const t=!e.lockoutEnd,n=1===e.twoFactorEnforced;return`\n    <tr>\n      <td><strong>${escapeHtml(e.userName)}</strong></td>\n      <td>${escapeHtml(e.email||"")}</td>\n      <td>\n        ${e.twoFactorEnabled?'<span class="badge badge-success">Enabled</span>':'<span class="badge">Disabled</span>'}\n      </td>\n      <td>\n        <div class="toggle-wrapper">\n          <label class="toggle-switch">\n            <input \n              type="checkbox" \n              ${t?"checked":""}\n              data-action="toggle-status"\n              data-id="${e.id}"\n              data-current-status="${t?"active":"disabled"}">\n            <span class="toggle-slider"></span>\n          </label>\n          <span class="toggle-label">${t?"Active":"Disabled"}</span>\n        </div>\n      </td>\n      <td>\n          <div class="toggle-wrapper">\n            <label class="toggle-switch">\n              <input \n                type="checkbox" \n                ${n?"checked":""}\n                data-action="toggle-2fa-enforce"\n                data-id="${e.id}"\n                data-current-2fa="${n?"enforced":"unenforced"}">\n              <span class="toggle-slider"></span>\n            </label>\n            <span class="toggle-label">Enforce 2FA</span>\n          </div>\n      </td>\n      <td>\n        <div style="display: flex; align-items: center; gap: var(--space-md);">          \n          <button class="btn btn-sm btn-danger" data-action="delete" data-method="DELETE" data-id="${e.id}">Delete</button>\n        </div>\n      </td>\n    </tr>\n  `}function escapeHtml(e){return e?e.replace(/[&<>"']/g,(e=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[e]))):""}