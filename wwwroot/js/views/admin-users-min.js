import{api,setCsrfToken}from"../api.js";import{updateHeader}from"../header.js";import{hasRole,renderAccessDenied}from"../auth-utils.js";import{t}from"../i18n.js";export function registerAdminUsers(e){e("/admin/users",(async e=>{try{const n=await api("/auth/me");if(updateHeader(n),!hasRole(n,"Admin"))return void(e.innerHTML=renderAccessDenied(n,"/admin/users","Admin",t("errors.adminAccessRequired")||"You need administrator privileges to access this page."));const a=await api("/admin/users");e.innerHTML=`\n        <div class="section">\n          <div class="section-header">\n            <h2 class="section-title mb-0">Users</h2>\n            <button class="btn btn-primary" id="add-user-btn">Add User</button>\n          </div>\n          \n          <div class="card">\n            <div class="table-container">\n              <table class="table">\n                <thead>\n                  <tr>\n                    <th>Name</th>\n                    <th>Email</th>\n                    <th>2FA</th>\n                    <th>Status</th>\n                    <th>Actions</th>\n                  </tr>\n                </thead>\n                <tbody>\n                  ${a.map((t=>renderUserRow(t))).join("")}\n                </tbody>\n              </table>\n            </div>\n          </div>\n          \n          <div id="message" class="alert alert-success hidden"></div>\n        </div>`,e.addEventListener("click",(async t=>{const n=t.target.closest("button[data-action]");if(!n)return;const a=n.getAttribute("data-action"),s=n.getAttribute("data-method"),d=n.getAttribute("data-id"),r=e.querySelector("#message");if(!d||!r)return;const i={enable:`/admin/users/${d}/enable`,disable:`/admin/users/${d}/disable`,enforce2fa:`/admin/users/${d}/enforce-2fa`,unenforce2fa:`/admin/users/${d}/unenforce-2fa`,delete:`/admin/users/${d}/delete`};try{const t=await api(i[a],{method:s});r.textContent="Action completed successfully!",r.className="alert alert-success",r.classList.remove("hidden"),t?.csrfToken&&setCsrfToken(t.csrfToken),setTimeout((()=>{location.reload()}),1e3)}catch(t){const e=t;r.textContent=e.message||"An error occurred",r.className="alert alert-danger",r.classList.remove("hidden")}}))}catch(t){const n=t;if(n.message.includes("Unauthorized")||n.message.includes("401")||n.message.includes("403"))return void(location.hash="/login");e.innerHTML=`\n        <div class="section">\n          <div class="alert alert-danger">\n            <strong>Error:</strong> ${escapeHtml(n.message||"Failed to load users")}\n          </div>\n        </div>`}}))}function renderUserRow(t){return`\n    <tr>\n      <td><strong>${escapeHtml(t.userName)}</strong></td>\n      <td>${escapeHtml(t.email||"")}</td>\n      <td>\n        ${t.twoFactorEnabled?'<span class="badge badge-success">Enabled</span>':'<span class="badge">Disabled</span>'}\n      </td>\n      <td>\n        ${t.lockoutEnd?'<span class="badge badge-danger">Locked</span>':'<span class="badge badge-success">Active</span>'}\n      </td>\n      <td>\n        <div class="button-group">\n          ${t.lockoutEnd?`<button class="btn btn-sm btn-success" data-action="enable" data-method="PUT" data-id="${t.id}">Enable</button>`:`<button class="btn btn-sm btn-ghost" data-action="disable" data-method="PUT" data-id="${t.id}">Disable</button>`}\n          ${1===t.twoFactorEnforced?`<button class="btn btn-sm btn-success" data-action="unenforce2fa" data-method="PUT" data-id="${t.id}">unenforce 2fa</button>`:`<button class="btn btn-sm btn-ghost" data-action="enforce2fa" data-method="PUT" data-id="${t.id}">enforce 2fa</button>`}\n          <button class="btn btn-sm btn-danger" data-action="delete" data-method="DELETE" data-id="${t.id}">Delete</button>\n        </div>\n      </td>\n    </tr>\n  `}function escapeHtml(t){return t?t.replace(/[&<>"']/g,(t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[t]))):""}