import{api,setCsrfToken}from"../api.js";import{updateHeader}from"../header.js";import{icon,Icons}from"../icons.js";import{t}from"../i18n.js";export function registerProfile(e){e("/profile",(async e=>{try{const n=await api("/auth/me");updateHeader(n);const a=await api("/profile/me");let s="";a.twoFactorEnabled&&1===a.twoFactorEnforced?s='<span class="text-muted pr-10">'+t("profile.security.twoFactorEnforced")+':</span><span class="badge badge-success">2fa '+t("common.enabled")+"</span>":a.twoFactorEnabled&&0===a.twoFactorEnforced?s=s='<span class="text-muted pr-10">'+t("profile.security.twoFactorEnabledAlready")+'</span><br><button class="btn btn-danger mt-25" data-action="disable-2fa" id="disable-2fa">'+t("profile.security.disable2FA")+"</button>":!1===a.twoFactorEnabled&&(s='<span class="text-muted pr-10">'+t("profile.security.twoFactorRecommended")+'</span><br><a href="/#/setup-2fa" class="btn btn-success mt-25" id="enable-2fa">'+t("profile.security.enable2FA")+"</a>"),e.innerHTML=`\n        <div class="section">\n          <h2 class="section-title">${t("profile.title")}</h2>\n          <div class="grid">\n          \x3c!-- Profile Information Card --\x3e\n          <div class="card mb-10 shadow-md">\n            <h3>${t("profile.personalInfo.title")}</h3>\n            <p class="text-muted">${t("home.account.description")}</p>\n            \n            <form id="profile-form" class="form">\n              <div class="form-group">\n                <label for="firstName" class="label">${t("profile.personalInfo.firstName")}</label>\n                <input \n                  type="text" \n                  id="firstName" \n                  name="firstName" \n                  class="input" \n                  value="${escapeHtml(a.firstName||"")}"\n                  placeholder="${t("profile.personalInfo.firstName")}"\n                />\n              </div>\n              \n              <div class="form-group">\n                <label for="lastName" class="label">${t("profile.personalInfo.lastName")}</label>\n                <input \n                  type="text" \n                  id="lastName" \n                  name="lastName" \n                  class="input" \n                  value="${escapeHtml(a.lastName||"")}"\n                  placeholder="${t("profile.personalInfo.lastName")}"\n                />\n              </div>\n              \n              <div class="form-group">\n                <label for="email" class="label">${t("profile.personalInfo.email")}</label>\n                <input \n                  type="email" \n                  id="email" \n                  name="email" \n                  class="input" \n                  value="${escapeHtml(a.email||"")}"\n                  placeholder="${t("auth.forgotPassword.emailPlaceholder")}"\n                  required\n                />\n                <small class="form-hint">${t("auth.register.optional")}</small>\n              </div>\n              \n              <div id="profile-message"></div>\n              \n              <button type="submit" class="btn btn-primary">${t("profile.personalInfo.save")}</button>\n            </form>\n          </div>\n          \n          \x3c!-- Change Password Card --\x3e\n          <div class="card mb-10 shadow-md">\n            <h3>${t("profile.security.title")}</h3>\n            <p class="text-muted">${t("profile.security.changePassword")}</p>\n            \n            <form id="password-form" class="form">\n              <div class="form-group">\n                <label for="currentPassword" class="label">${t("profile.security.currentPassword")}</label>\n                <div class="input-with-actions">\n                  <input \n                    type="password" \n                    id="currentPassword" \n                    name="currentPassword" \n                    class="input" \n                    placeholder="${t("profile.security.currentPassword")}"\n                    required\n                    autocomplete="current-password"\n                  />\n                  <button type="button" class="input-action-btn" data-toggle-password="currentPassword" aria-label="Toggle password visibility">\n                    ${icon(Icons.EYE)}\n                  </button>\n                </div>\n              </div>\n              \n              <div class="form-group">\n                <label for="newPassword" class="label">${t("profile.security.newPassword")}</label>\n                <div class="input-with-actions">\n                  <input \n                    type="password" \n                    id="newPassword" \n                    name="newPassword" \n                    class="input" \n                    placeholder="${t("profile.security.newPassword")}"\n                    required\n                    autocomplete="new-password"\n                    minlength="6"\n                  />\n                  <button type="button" class="input-action-btn" data-generate-password="newPassword" aria-label="Generate secure password">\n                    ${icon(Icons.KEY)}\n                  </button>\n                  <button type="button" class="input-action-btn" data-toggle-password="newPassword" aria-label="Toggle password visibility">\n                    ${icon(Icons.EYE)}\n                  </button>\n                </div>\n                <small class="form-hint">${t("profile.security.newPasswordToShort")}</small>\n              </div>\n              \n              <div class="form-group">\n                <label for="confirmPassword" class="label">${t("profile.security.confirmPassword")}</label>\n                <div class="input-with-actions">\n                  <input \n                    type="password" \n                    id="confirmPassword" \n                    name="confirmPassword" \n                    class="input" \n                    placeholder="${t("profile.security.confirmPassword")}"\n                    required\n                    autocomplete="new-password"\n                    minlength="6"\n                  />\n                  <button type="button" class="input-action-btn" data-toggle-password="confirmPassword" aria-label="Toggle password visibility">\n                    ${icon(Icons.EYE)}\n                  </button>\n                </div>\n              </div>\n              \n              <div id="password-message"></div>\n              \n              <button type="submit" class="btn btn-primary">${t("profile.security.changePassword")}</button>\n            </form>\n          </div>\n          \n          \x3c!-- Account Information --\x3e\n          <div class="card mb-10 shadow-md">\n            <h3>${t("profile.accountInfo.title")}</h3>\n            <div class="form-group form-row">\n              <div>\n                <span class="text-muted">${t("profile.accountInfo.createdAt")}:</span>\n                <strong>${formatDate(a.createdAt)}</strong>\n              </div>\n            </div>\n            ${a.updatedAt?`\n              <div class="form-group form-row">\n                <div>\n                  <span class="text-muted">${t("common.lastUpdate")}:</span>\n                  <strong>${formatDate(a.updatedAt)}</strong>\n                </div>\n              </div>\n            `:""}\n            <div class="form-group form-row pb-10">\n              <div>\n                <span class="text-muted">${t("profile.security.twoFactor")}:</span>\n                <strong>${a.twoFactorEnabled?'<span class="badge badge-success">'+t("common.enabled")+"</span>":'<span class="badge">'+t("common.disabled")+"</span>"}</strong>\n              </div>\n            </div>\n            <hr class="mt-10 mb-10">\n            <h3 class="pt-10">${t("profile.personalInfo.2fainfo")}</h3>\n            <div class="form-group form-row">              \n              <div>   \n                ${s||""}\n              </div>\n            </div>\n          </div>\n          </div>\n        </div>`;const r=e.querySelector("#profile-form");r&&r.addEventListener("submit",(async t=>{t.preventDefault(),await handleProfileUpdate(e,a)}));const o=e.querySelector("#password-form");o&&o.addEventListener("submit",(async t=>{t.preventDefault(),await handlePasswordChange(e)}));const i=e.querySelector("#disable-2fa");i&&i.addEventListener("click",(async t=>{t.preventDefault(),await handle2faDeactivate(e,a)})),setupPasswordToggles(e),setupPasswordGenerator(e)}catch(n){const a=n;if(a.message.includes("Unauthorized")||a.message.includes("401")||a.message.includes("403"))return void(location.hash="/login");e.innerHTML=`\n        <div class="section">\n          <div class="alert alert-danger">\n            <strong>Error:</strong> ${escapeHtml(a.message||t("profile.errors.failedToLoadProfile"))}\n          </div>\n        </div>`}}))}async function handle2faDeactivate(e,n){const a=e.querySelector("#profile-message");if(a){a.innerHTML="",a.className="";try{const e=await api("/auth/2fa/disable",{method:"POST",body:{id:n.id}});e?.csrfToken&&setCsrfToken(e.csrfToken),a.textContent=t("profile.security.twoFactorDisabledSuccess"),a.className="alert alert-success",setTimeout((()=>{location.reload()}),1500)}catch(e){const t=e;a.textContent=t.message,a.className="alert alert-danger"}}}async function handleProfileUpdate(e,n){const a=e.querySelector("#profile-message");if(!a)return;a.innerHTML="",a.className="";const s=e.querySelector("#profile-form");if(!s)return;const r=s.querySelector("#firstName"),o=s.querySelector("#lastName"),i=s.querySelector("#email");if(!i)return;const l=r?.value.trim()||"",c=o?.value.trim()||"",d=i.value.trim();if(!d)return a.textContent=t("profile.security.emailRequired"),void(a.className="alert alert-danger");try{const e={firstName:l||void 0,lastName:c||void 0,email:d!==n.email?d:void 0};if(!e.firstName&&!e.lastName&&!e.email)return a.textContent=t("profile.security.noChangesDetected"),void(a.className="alert alert-info");const s=await api("/profile/update",{method:"PUT",body:e});if(s?.csrfToken&&setCsrfToken(s.csrfToken),s.emailChanged)return a.textContent=s.message||t("profile.security.successUpdateProfileLogin"),a.className="alert alert-success",void setTimeout((()=>{location.hash="/login"}),2e3);a.textContent=s.message||t("profile.security.successUpdateProfile"),a.className="alert alert-success",setTimeout((()=>{location.reload()}),1500)}catch(e){const n=e;a.textContent=n.message||t("profile.security.failedUpdateProfile"),a.className="alert alert-danger"}}async function handlePasswordChange(e){const n=e.querySelector("#password-message");if(!n)return;n.innerHTML="",n.className="";const a=e.querySelector("#password-form");if(!a)return;const s=a.querySelector("#currentPassword"),r=a.querySelector("#newPassword"),o=a.querySelector("#confirmPassword");if(!s||!r||!o)return;const i=s.value,l=r.value,c=o.value;if(!i||!l||!c)return n.textContent=t("profile.security.allPwFieldsRequired"),void(n.className="alert alert-danger");if(l!==c)return n.textContent=t("profile.security.newPasswordNotMatch"),void(n.className="alert alert-danger");if(l.length<6)return n.textContent=t("profile.security.newPasswordToShort"),void(n.className="alert alert-danger");if(i===l)return n.textContent=t("profile.security.newPasswordNotDifferent"),void(n.className="alert alert-danger");try{const e={currentPassword:i,newPassword:l},s=await api("/profile/change-password",{method:"PUT",body:e});s?.csrfToken&&setCsrfToken(s.csrfToken),n.textContent=t("profile.security.pwChangeSuccess"),n.className="alert alert-success",a.reset()}catch(e){const a=e;n.textContent=a.message||t("errors.pwChangeError"),n.className="alert alert-danger"}}function setupPasswordToggles(e){e.querySelectorAll("[data-toggle-password]").forEach((n=>{n.addEventListener("click",(()=>{const a=n.getAttribute("data-toggle-password");if(!a)return;const s=e.querySelector(`#${a}`);if(!s)return;const r="password"===s.type;s.type=r?"text":"password",n.innerHTML=icon(r?Icons.EYE_OFF:Icons.EYE),n.setAttribute("aria-label",t(r?"common.hidePwd":"common.showPwd"))}))}))}function setupPasswordGenerator(e){e.querySelectorAll("[data-generate-password]").forEach((t=>{t.addEventListener("click",(()=>{const n=t.getAttribute("data-generate-password");if(!n)return;const a=e.querySelector(`#${n}`);if(!a)return;const s=generateSecurePassword();a.value=s,a.type="text";const r=e.querySelector(`[data-toggle-password="${n}"]`);r&&(r.innerHTML=icon(Icons.EYE_OFF),r.setAttribute("aria-label","Hide password")),navigator.clipboard.writeText(s).then((()=>{const e=t.innerHTML;t.innerHTML=icon(Icons.CHECK),setTimeout((()=>{t.innerHTML=e}),2e3)})).catch((()=>{}))}))}))}function generateSecurePassword(){const e="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*",t=new Uint32Array(16);window.crypto.getRandomValues(t);let n="";for(let a=0;a<16;a++)n+=e[t[a]%e.length];const a=/[a-z]/.test(n),s=/[A-Z]/.test(n),r=/[0-9]/.test(n),o=/[!@#$%^&*]/.test(n);return a&&s&&r&&o?n:generateSecurePassword()}function formatDate(e){if(!e)return"N/A";return new Date(e).toLocaleDateString("en-US",{year:"numeric",month:"numeric",day:"numeric",hour:"2-digit",minute:"2-digit"})}function escapeHtml(e){return e?e.replace(/[&<>"']/g,(e=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[e]))):""}