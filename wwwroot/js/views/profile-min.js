import{api,setCsrfToken}from"../api.js";import{updateHeader}from"../header.js";import{icon,Icons}from"../icons.js";import{t}from"../i18n.js";export function registerProfile(e){e("/profile",(async e=>{try{const n=await api("/auth/me");updateHeader(n);const s=await api("/profile/me");e.innerHTML=`\n        <div class="section">\n          <h2 class="section-title">${t("profile.title")}</h2>\n          <div class="grid">\n          \x3c!-- Profile Information Card --\x3e\n          <div class="card mb-10 shadow-md">\n            <h3>${t("profile.personalInfo.title")}</h3>\n            <p class="text-muted">${t("home.account.description")}</p>\n            \n            <form id="profile-form" class="form">\n              <div class="form-group">\n                <label for="firstName" class="label">${t("profile.personalInfo.firstName")}</label>\n                <input \n                  type="text" \n                  id="firstName" \n                  name="firstName" \n                  class="input" \n                  value="${escapeHtml(s.firstName||"")}"\n                  placeholder="${t("profile.personalInfo.firstName")}"\n                />\n              </div>\n              \n              <div class="form-group">\n                <label for="lastName" class="label">${t("profile.personalInfo.lastName")}</label>\n                <input \n                  type="text" \n                  id="lastName" \n                  name="lastName" \n                  class="input" \n                  value="${escapeHtml(s.lastName||"")}"\n                  placeholder="${t("profile.personalInfo.lastName")}"\n                />\n              </div>\n              \n              <div class="form-group">\n                <label for="email" class="label">${t("profile.personalInfo.email")}</label>\n                <input \n                  type="email" \n                  id="email" \n                  name="email" \n                  class="input" \n                  value="${escapeHtml(s.email||"")}"\n                  placeholder="${t("auth.forgotPassword.emailPlaceholder")}"\n                  required\n                />\n                <small class="form-hint">${t("auth.register.optional")}</small>\n              </div>\n              \n              <div id="profile-message"></div>\n              \n              <button type="submit" class="btn btn-primary">${t("profile.personalInfo.save")}</button>\n            </form>\n          </div>\n          \n          \x3c!-- Change Password Card --\x3e\n          <div class="card mb-10 shadow-md">\n            <h3>${t("profile.security.title")}</h3>\n            <p class="text-muted">${t("profile.security.changePassword")}</p>\n            \n            <form id="password-form" class="form">\n              <div class="form-group">\n                <label for="currentPassword" class="label">${t("profile.security.currentPassword")}</label>\n                <div class="input-with-actions">\n                  <input \n                    type="password" \n                    id="currentPassword" \n                    name="currentPassword" \n                    class="input" \n                    placeholder="${t("profile.security.currentPassword")}"\n                    required\n                    autocomplete="current-password"\n                  />\n                  <button type="button" class="input-action-btn" data-toggle-password="currentPassword" aria-label="Toggle password visibility">\n                    ${icon(Icons.EYE)}\n                  </button>\n                </div>\n              </div>\n              \n              <div class="form-group">\n                <label for="newPassword" class="label">${t("profile.security.newPassword")}</label>\n                <div class="input-with-actions">\n                  <input \n                    type="password" \n                    id="newPassword" \n                    name="newPassword" \n                    class="input" \n                    placeholder="${t("profile.security.newPassword")}"\n                    required\n                    autocomplete="new-password"\n                    minlength="6"\n                  />\n                  <button type="button" class="input-action-btn" data-generate-password="newPassword" aria-label="Generate secure password">\n                    ${icon(Icons.KEY)}\n                  </button>\n                  <button type="button" class="input-action-btn" data-toggle-password="newPassword" aria-label="Toggle password visibility">\n                    ${icon(Icons.EYE)}\n                  </button>\n                </div>\n                <small class="form-hint">${t("profile.security.newPasswordToShort")}</small>\n              </div>\n              \n              <div class="form-group">\n                <label for="confirmPassword" class="label">${t("profile.security.confirmPassword")}</label>\n                <div class="input-with-actions">\n                  <input \n                    type="password" \n                    id="confirmPassword" \n                    name="confirmPassword" \n                    class="input" \n                    placeholder="${t("profile.security.confirmPassword")}"\n                    required\n                    autocomplete="new-password"\n                    minlength="6"\n                  />\n                  <button type="button" class="input-action-btn" data-toggle-password="confirmPassword" aria-label="Toggle password visibility">\n                    ${icon(Icons.EYE)}\n                  </button>\n                </div>\n              </div>\n              \n              <div id="password-message"></div>\n              \n              <button type="submit" class="btn btn-primary">${t("profile.security.changePassword")}</button>\n            </form>\n          </div>\n          \n          \x3c!-- Account Information --\x3e\n          <div class="card mb-10 shadow-md">\n            <h3>${t("profile.accountInfo.title")}</h3>\n            <div class="form-group form-row">\n              <div>\n                <span class="text-muted">${t("profile.accountInfo.createdAt")}:</span>\n                <strong>${formatDate(s.createdAt)}</strong>\n              </div>\n            </div>\n            ${s.updatedAt?`\n              <div class="form-group form-row">\n                <div>\n                  <span class="text-muted">${t("common.lastUpdate")}:</span>\n                  <strong>${formatDate(s.updatedAt)}</strong>\n                </div>\n              </div>\n            `:""}\n            <div class="form-group form-row">\n              <div>\n                <span class="text-muted">${t("profile.security.twoFactor")}:</span>\n                <strong>${s.twoFactorEnabled?'<span class="badge badge-success">'+t("common.enabled")+"</span>":'<span class="badge">'+t("common.disabled")+"</span>"}</strong>\n              </div>\n            </div>\n          </div>\n          </div>\n        </div>`;const r=e.querySelector("#profile-form");r&&r.addEventListener("submit",(async t=>{t.preventDefault(),await handleProfileUpdate(e,s)}));const a=e.querySelector("#password-form");a&&a.addEventListener("submit",(async t=>{t.preventDefault(),await handlePasswordChange(e)})),setupPasswordToggles(e),setupPasswordGenerator(e)}catch(n){const s=n;if(s.message.includes("Unauthorized")||s.message.includes("401")||s.message.includes("403"))return void(location.hash="/login");e.innerHTML=`\n        <div class="section">\n          <div class="alert alert-danger">\n            <strong>Error:</strong> ${escapeHtml(s.message||t("profile.errors.failedToLoadProfile"))}\n          </div>\n        </div>`}}))}async function handleProfileUpdate(e,n){const s=e.querySelector("#profile-message");if(!s)return;s.innerHTML="",s.className="";const r=e.querySelector("#profile-form");if(!r)return;const a=r.querySelector("#firstName"),o=r.querySelector("#lastName"),i=r.querySelector("#email");if(!i)return;const l=a?.value.trim()||"",c=o?.value.trim()||"",d=i.value.trim();if(!d)return s.textContent=t("profile.security.emailRequired"),void(s.className="alert alert-danger");try{const e={firstName:l||void 0,lastName:c||void 0,email:d!==n.email?d:void 0};if(!e.firstName&&!e.lastName&&!e.email)return s.textContent=t("profile.security.noChangesDetected"),void(s.className="alert alert-info");const r=await api("/profile/update",{method:"PUT",body:e});if(r?.csrfToken&&setCsrfToken(r.csrfToken),r.emailChanged)return s.textContent=r.message||t("profile.security.successUpdateProfileLogin"),s.className="alert alert-success",void setTimeout((()=>{location.hash="/login"}),2e3);s.textContent=r.message||t("profile.security.successUpdateProfile"),s.className="alert alert-success",setTimeout((()=>{location.reload()}),1500)}catch(e){const n=e;s.textContent=n.message||t("profile.security.failedUpdateProfile"),s.className="alert alert-danger"}}async function handlePasswordChange(e){const n=e.querySelector("#password-message");if(!n)return;n.innerHTML="",n.className="";const s=e.querySelector("#password-form");if(!s)return;const r=s.querySelector("#currentPassword"),a=s.querySelector("#newPassword"),o=s.querySelector("#confirmPassword");if(!r||!a||!o)return;const i=r.value,l=a.value,c=o.value;if(!i||!l||!c)return n.textContent=t("profile.security.allPwFieldsRequired"),void(n.className="alert alert-danger");if(l!==c)return n.textContent=t("profile.security.newPasswordNotMatch"),void(n.className="alert alert-danger");if(l.length<6)return n.textContent=t("profile.security.newPasswordToShort"),void(n.className="alert alert-danger");if(i===l)return n.textContent=t("profile.security.newPasswordNotDifferent"),void(n.className="alert alert-danger");try{const e={currentPassword:i,newPassword:l},r=await api("/profile/change-password",{method:"PUT",body:e});r?.csrfToken&&setCsrfToken(r.csrfToken),n.textContent=t("profile.security.pwChangeSuccess"),n.className="alert alert-success",s.reset()}catch(e){const s=e;n.textContent=s.message||t("errors.pwChangeError"),n.className="alert alert-danger"}}function setupPasswordToggles(e){e.querySelectorAll("[data-toggle-password]").forEach((n=>{n.addEventListener("click",(()=>{const s=n.getAttribute("data-toggle-password");if(!s)return;const r=e.querySelector(`#${s}`);if(!r)return;const a="password"===r.type;r.type=a?"text":"password",n.innerHTML=icon(a?Icons.EYE_OFF:Icons.EYE),n.setAttribute("aria-label",t(a?"common.hidePwd":"common.showPwd"))}))}))}function setupPasswordGenerator(e){e.querySelectorAll("[data-generate-password]").forEach((t=>{t.addEventListener("click",(()=>{const n=t.getAttribute("data-generate-password");if(!n)return;const s=e.querySelector(`#${n}`);if(!s)return;const r=generateSecurePassword();s.value=r,s.type="text";const a=e.querySelector(`[data-toggle-password="${n}"]`);a&&(a.innerHTML=icon(Icons.EYE_OFF),a.setAttribute("aria-label","Hide password")),navigator.clipboard.writeText(r).then((()=>{const e=t.innerHTML;t.innerHTML=icon(Icons.CHECK),setTimeout((()=>{t.innerHTML=e}),2e3)})).catch((()=>{}))}))}))}function generateSecurePassword(){const e="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*",t=new Uint32Array(16);window.crypto.getRandomValues(t);let n="";for(let s=0;s<16;s++)n+=e[t[s]%e.length];const s=/[a-z]/.test(n),r=/[A-Z]/.test(n),a=/[0-9]/.test(n),o=/[!@#$%^&*]/.test(n);return s&&r&&a&&o?n:generateSecurePassword()}function formatDate(e){if(!e)return"N/A";return new Date(e).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"})}function escapeHtml(e){return e?e.replace(/[&<>"']/g,(e=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[e]))):""}