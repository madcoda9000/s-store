import{api}from"../api.js";import{updateHeader}from"../header.js";import{icon,Icons}from"../icons.js";import{t}from"../i18n.js";import{hasRole,renderAccessDenied}from"../auth-utils.js";const state={currentPage:1,pageSize:10,sortBy:"timestamp",sortOrder:"desc",searchQuery:"",fromDate:"",toDate:""};let errorClickHandler=null;export function registerErrorLogs(e){e("/logs/error",(async e=>{try{state.currentPage=1,state.pageSize=10,state.sortBy="timestamp",state.sortOrder="desc",state.searchQuery="",state.fromDate="",state.toDate="";const n=await api("/auth/me");if(updateHeader(n),!hasRole(n,"Admin"))return void(e.innerHTML=renderAccessDenied(n,"/logs/error","Admin",t("errors.adminAccessRequired")));e.innerHTML=renderView(null,!0),setupEventHandlers(e),updateClearButton(e),await loadLogs(e)}catch(t){const n=t;if(n.message.includes("Unauthorized")||n.message.includes("401"))return void(location.hash="/login");e.innerHTML=renderError(n.message)}}))}async function loadLogs(e){try{const n=e.querySelector("#logs-container");n&&(n.innerHTML=`<div class="log-loading"><div class="spinner"></div><p>${t("admin.errorLogs.loadingLogs")}</p></div>`);const a=e.querySelector("#log-search");a&&(a.value=state.searchQuery);const s=e.querySelector("#page-size");s&&(s.value=state.pageSize.toString());const r=e.querySelector("#from-date");r&&(r.value=state.fromDate);const o=e.querySelector("#to-date");o&&(o.value=state.toDate),updateClearButton(e);const i=new URLSearchParams({page:state.currentPage.toString(),size:state.pageSize.toString()});state.fromDate&&i.append("fromDate",new Date(state.fromDate).toISOString()),state.toDate&&i.append("toDate",new Date(state.toDate).toISOString());const l=await api(`/log/error?${i.toString()}`);let c=l.logs;if(state.searchQuery){const e=state.searchQuery.toLowerCase();c=c.filter((t=>t.action.toLowerCase().includes(e)||t.context.toLowerCase().includes(e)||t.message.toLowerCase().includes(e)||t.user.toLowerCase().includes(e)))}c=sortLogs(c,state.sortBy,state.sortOrder),n&&(n.innerHTML=renderLogsTable({logs:c,pagination:l.pagination}))}catch(t){const n=t,a=e.querySelector("#logs-container");a&&(a.innerHTML=`<div class="log-error"><div class="alert alert-danger">${escapeHtml(n.message)}</div></div>`)}}function updateClearButton(e){const n=e.querySelector(".log-search-bar");if(!n)return;let a=n.querySelector("#clear-search-btn");state.searchQuery?a||(a=document.createElement("button"),a.id="clear-search-btn",a.className="btn btn-secondary ml-10",a.type="button",a.innerHTML=`${icon(Icons.X,"icon")} ${t("admin.errorLogs.clear")}`,n.appendChild(a)):a&&a.remove();const s=e.querySelector(".log-filter-actions"),r=Boolean(state.searchQuery||state.fromDate||state.toDate);if(s){let e=s.querySelector("#clear-date-filters-btn");r?e||(e=document.createElement("button"),e.id="clear-date-filters-btn",e.className="btn btn-secondary",e.type="button",e.innerHTML=`${icon(Icons.X,"icon")} ${t("admin.errorLogs.clearFilters")}`,s.appendChild(e)):e&&e.remove()}}function sortLogs(e,t,n){return[...e].sort(((e,a)=>{let s=e[t],r=a[t];return"timestamp"===t&&(s=new Date(s).getTime(),r=new Date(r).getTime()),"asc"===n?s>r?1:-1:s<r?1:-1}))}function renderView(e,n){return`\n    <div class="section">\n      <div class="section-header">\n        <h2 class="section-title mb-0">${icon(Icons.ERROR_BUG,"icon")} ${t("admin.errorLogs.title")}</h2>\n      </div>\n\n      ${renderFilters()}\n\n      <div id="logs-container">\n        ${n?renderLoading():e?renderLogsTable(e):""}\n      </div>\n    </div>\n  `}function renderFilters(){return`\n    <div class="log-search-bar">\n      <input\n        type="text"\n        id="log-search"\n        class="input"\n        placeholder="${t("admin.errorLogs.searchPlaceholder")}"\n        value="${escapeHtml(state.searchQuery)}"\n      />\n      <button id="search-btn" class="btn btn-primary" type="button">\n        ${icon(Icons.SEARCH,"icon")} ${t("common.search")}\n      </button>\n    </div>\n\n    <div class="log-filters">\n      <div class="form-group">\n        <label for="from-date" class="label">${t("admin.errorLogs.fromDate")}</label>\n        <input\n          type="datetime-local"\n          id="from-date"\n          class="input"\n          value="${state.fromDate}"\n        />\n      </div>\n\n      <div class="form-group">\n        <label for="to-date" class="label">${t("admin.errorLogs.toDate")}</label>\n        <input\n          type="datetime-local"\n          id="to-date"\n          class="input"\n          value="${state.toDate}"\n        />\n      </div>\n\n      <div class="form-group">\n        <label class="label label-invisible">${t("admin.errorLogs.applyFilters")}</label>\n        <div class="log-filter-actions">\n          <button id="apply-filters-btn" class="btn btn-primary" type="button">\n            ${t("admin.errorLogs.applyFilters")}\n          </button>\n        </div>\n      </div>\n    </div>\n\n    <div class="log-filters">\n      <div class="page-size-selector">\n        <label for="page-size">${t("admin.logs.showPerPage")}</label>\n        <select id="page-size">\n          <option value="10" ${10===state.pageSize?"selected":""}>10</option>\n          <option value="20" ${20===state.pageSize?"selected":""}>20</option>\n          <option value="50" ${50===state.pageSize?"selected":""}>50</option>\n          <option value="100" ${100===state.pageSize?"selected":""}>100</option>\n        </select>\n        <span>${t("admin.logs.perPage")}</span>\n      </div>\n    </div>\n  `}function renderLogsTable(e){return e.logs&&0!==e.logs.length?`\n    <div class="log-table-container">\n      <table class="log-table log-table--dense">\n        <thead>\n          <tr>\n            <th class="sortable ${"timestamp"===state.sortBy?"sort-"+state.sortOrder:""}" data-sort="timestamp">\n              ${t("admin.logs.timestamp")}\n            </th>\n            <th class="sortable ${"user"===state.sortBy?"sort-"+state.sortOrder:""}" data-sort="user">\n              ${t("admin.logs.user")}\n            </th>\n            <th class="sortable ${"action"===state.sortBy?"sort-"+state.sortOrder:""}" data-sort="action">\n              ${t("admin.logs.action")}\n            </th>\n            <th class="sortable hide-mobile ${"context"===state.sortBy?"sort-"+state.sortOrder:""}" data-sort="context">\n              ${t("admin.logs.context")}\n            </th>\n            <th>${t("admin.logs.message")}</th>\n          </tr>\n        </thead>\n        <tbody>\n          ${e.logs.map((e=>renderLogRow(e))).join("")}\n        </tbody>\n      </table>\n    </div>\n\n    ${renderPagination(e.pagination)}\n  `:`\n      <div class="log-empty-state">\n        ${icon(Icons.ALERT_TRIANGLE,"icon")}\n        <p>${t("admin.errorLogs.noLogsFound")}</p>\n      </div>\n    `}function renderLogRow(e){return`\n    <tr>\n      <td class="log-cell-timestamp">${formatTimestamp(e.timestamp)}</td>\n      <td class="log-cell-user">${escapeHtml(e.user)}</td>\n      <td class="log-cell-action">${escapeHtml(e.action)}</td>\n      <td class="log-cell-context hide-mobile">${escapeHtml(e.context)}</td>\n      <td class="log-cell-message">${escapeHtml(e.message)}</td>\n    </tr>\n  `}function renderPagination(e){if(!e||e.totalPages<=1)return"";const{page:n,totalPages:a,total:s}=e,r=(n-1)*state.pageSize+1,o=Math.min(n*state.pageSize,s),i=[];if(a<=7)for(let e=1;e<=a;e++)i.push(e);else if(n<=4){for(let e=1;e<=5;e++)i.push(e);i.push("..."),i.push(a)}else if(n>=a-3){i.push(1),i.push("...");for(let e=a-4;e<=a;e++)i.push(e)}else{i.push(1),i.push("...");for(let e=n-1;e<=n+1;e++)i.push(e);i.push("..."),i.push(a)}return`\n    <div class="pagination">\n      <div class="pagination-info">\n        ${t("admin.logs.showing",{start:r,end:o,total:s})}\n      </div>\n\n      <div class="pagination-controls">\n        <button\n          class="pagination-btn"\n          data-page="${n-1}"\n          ${1===n?"disabled":""}\n        >\n          ${icon(Icons.CHEVRON_LEFT,"icon")}\n        </button>\n\n        ${i.map((e=>"..."===e?'<span class="pagination-ellipsis">...</span>':`\n            <button\n              class="pagination-btn ${e===n?"active":""} ${Math.abs(e-n)>2?"hide-mobile":""}"\n              data-page="${e}"\n              ${e===n?"disabled":""}\n            >\n              ${e}\n            </button>\n          `)).join("")}\n\n        <button\n          class="pagination-btn"\n          data-page="${n+1}"\n          ${n===a?"disabled":""}\n        >\n          ${icon(Icons.CHEVRON_RIGHT,"icon")}\n        </button>\n      </div>\n    </div>\n  `}function renderLoading(){return`\n    <div class="log-loading">\n      <div class="spinner"></div>\n      <p>${t("admin.errorLogs.loadingLogs")}</p>\n    </div>\n  `}function renderError(e){return`\n    <div class="section">\n      <div class="log-error">\n        <div class="alert alert-danger">\n          <strong>${t("admin.logs.error")}</strong> ${escapeHtml(e)}\n        </div>\n      </div>\n    </div>\n  `}function setupEventHandlers(e){errorClickHandler&&e.removeEventListener("click",errorClickHandler),errorClickHandler=function(t){if(!location.hash.startsWith("#/logs/error"))return;const n=t.target;if(n.closest("#search-btn")){const t=e.querySelector("#log-search");return void(t&&(state.searchQuery=t.value.trim(),state.currentPage=1,loadLogs(e)))}if(n.closest("#clear-search-btn"))return state.searchQuery="",state.currentPage=1,void loadLogs(e);if(n.closest("#apply-filters-btn")){const t=e.querySelector("#from-date"),n=e.querySelector("#to-date");return t&&(state.fromDate=t.value),n&&(state.toDate=n.value),state.currentPage=1,void loadLogs(e)}if(n.closest("#clear-date-filters-btn"))return state.searchQuery="",state.fromDate="",state.toDate="",state.currentPage=1,void loadLogs(e);const a=n.closest(".pagination-btn[data-page]");if(a&&!a.hasAttribute("disabled")){const t=parseInt(a.getAttribute("data-page")||"1");return state.currentPage=t,void loadLogs(e)}const s=n.closest(".sortable[data-sort]");if(s){const t=s.getAttribute("data-sort")||"timestamp";state.sortBy===t?state.sortOrder="asc"===state.sortOrder?"desc":"asc":(state.sortBy=t,state.sortOrder="desc"),loadLogs(e)}},e.addEventListener("click",errorClickHandler);const t=e.querySelector("#log-search");t&&t.addEventListener("keypress",(n=>{"Enter"===n.key&&(state.searchQuery=t.value.trim(),state.currentPage=1,loadLogs(e))}));const n=e.querySelector("#page-size");n&&n.addEventListener("change",(()=>{state.pageSize=parseInt(n.value),state.currentPage=1,loadLogs(e)}));const a=e.querySelector("#from-date");a&&a.addEventListener("change",(()=>{state.fromDate=a.value}));const s=e.querySelector("#to-date");s&&s.addEventListener("change",(()=>{state.toDate=s.value}))}function formatTimestamp(e){return new Date(e).toLocaleString(void 0,{year:"numeric",month:"short",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"})}function escapeHtml(e){if(!e)return"";const t=document.createElement("div");return t.textContent=e,t.innerHTML}