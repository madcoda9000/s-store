import{api,setCsrfToken}from"../api.js";import{hideHeader}from"../header.js";import{icon,Icons}from"../icons.js";export function registerVerifyEmail(e){e("/verify-email",(e=>{hideHeader();const t=new URLSearchParams(location.hash.split("?")[1]),n=t.get("token"),i=t.get("userId");n&&i?renderAutoVerification(e,n,i):renderManualVerification(e)}))}function renderAutoVerification(e,t,n){e.innerHTML=`\n    <div class="auth-container">\n      <div class="auth-wrapper">\n        <div class="card auth-card">\n          \n          <div class="auth-header">\n            <h1 class="auth-logo">S-Store</h1>\n            <p class="text-muted">Verifying your email...</p>\n          </div>\n          \n          <div class="loading-container">\n            <div class="spinner"></div>\n            <p class="text-muted mt-10">Please wait while we verify your email address</p>\n          </div>\n\n          <div id="verification-result" class="hidden"></div>\n          \n          <div class="auth-footer">\n            <p class="text-muted"><a href="#/login" class="link">Back to login</a></p>\n          </div>\n        </div>\n\n        <div class="auth-theme-toggle">\n          <button class="btn btn-icon" id="auth-theme-toggle" aria-label="Toggle theme">${getThemeIcon()}</button>\n        </div>\n      \n      </div>\n    </div>`;const i=e.querySelector("#verification-result"),a=e.querySelector(".loading-container"),r=e.querySelector("#auth-theme-toggle");r&&r.addEventListener("click",(()=>{const e=document.documentElement,t="light"===e.getAttribute("data-theme")?"dark":"light";e.setAttribute("data-theme",t),localStorage.setItem("theme",t),r.innerHTML=getThemeIcon()})),(async()=>{try{const e={userId:n,token:t},r=await api("/auth/verify-email",{method:"POST",body:e});r?.csrfToken&&setCsrfToken(r.csrfToken),a.classList.add("hidden"),i.innerHTML=`\n        <div class="alert alert-success">\n          <strong>Success!</strong> ${r.message||"Your email has been verified."}\n        </div>\n        <a href="#/login" class="btn btn-primary btn-block mt-10">Go to Login</a>\n      `,i.classList.remove("hidden")}catch(e){const t=e;a.classList.add("hidden"),i.innerHTML=`\n        <div class="alert alert-danger">\n          <strong>Verification Failed</strong><br>\n          ${t.message||"Invalid or expired verification link."}\n        </div>\n        <a href="#/verify-email" class="btn btn-secondary btn-block mt-10">Try Manual Verification</a>\n        <a href="#/login" class="btn btn-ghost btn-block">Back to Login</a>\n      `,i.classList.remove("hidden")}})()}function renderManualVerification(e){e.innerHTML=`\n    <div class="auth-container">\n      <div class="auth-wrapper">\n        <div class="card auth-card">\n          \n          <div class="auth-header">\n            <h1 class="auth-logo">S-Store</h1>\n            <p class="text-muted">Verify your email address</p>\n          </div>\n          \n          <form id="verify-form" class="form">\n            <div class="alert alert-info">\n              <strong>Check your email</strong><br>\n              We've sent a 6-digit verification code to your email address. Enter it below to verify your account.\n            </div>\n\n            <div class="form-group">\n              <label class="label" for="email">Email Address</label>\n              <input \n                type="email" \n                id="email" \n                name="email" \n                class="input" \n                placeholder="name@example.com"\n                autocomplete="email"\n                required>\n            </div>\n            \n            <div class="form-group">\n              <label class="label" for="code">Verification Code</label>\n              <input \n                type="text" \n                id="code" \n                name="code" \n                class="input" \n                placeholder="123456"\n                pattern="[0-9]{6}"\n                maxlength="6"\n                autocomplete="off"\n                required>\n              <p class="form-hint">Enter the 6-digit code from your email</p>\n            </div>\n            \n            <div id="verify-error" class="error hidden"></div>\n            \n            <button type="submit" class="btn btn-primary btn-block">Verify Email</button>\n          </form>\n\n          <div class="divider" style="margin: var(--space-lg) 0;"></div>\n\n          <div class="auth-footer">\n            <p class="text-muted">Didn't receive the email?</p>\n            <button id="resend-btn" class="btn btn-secondary btn-block">Resend Verification Email</button>\n            <p class="text-muted mt-10"><a href="#/login" class="link">Back to login</a></p>\n          </div>\n        </div>\n\n        <div class="auth-theme-toggle">\n          <button class="btn btn-icon" id="auth-theme-toggle" aria-label="Toggle theme">${getThemeIcon()}</button>\n        </div>\n      \n      </div>\n    </div>`;const t=e.querySelector("#verify-form"),n=e.querySelector("#verify-error"),i=e.querySelector("#resend-btn"),a=e.querySelector("#auth-theme-toggle");a&&a.addEventListener("click",(()=>{const e=document.documentElement,t="light"===e.getAttribute("data-theme")?"dark":"light";e.setAttribute("data-theme",t),localStorage.setItem("theme",t),a.innerHTML=getThemeIcon()})),t.addEventListener("submit",(async e=>{e.preventDefault(),n.classList.add("hidden"),n.textContent="";const i=new FormData(t),a={email:i.get("email")?.toString()||"",code:i.get("code")?.toString()||""};try{const e=await api("/auth/verify-email-code",{method:"POST",body:a});e?.csrfToken&&setCsrfToken(e.csrfToken),alert(e.message||"Email verified successfully! You can now log in."),location.hash="/login"}catch(e){const t=e;n.textContent=t.message||"Verification failed. Please check your code and try again.",n.classList.remove("hidden")}})),i.addEventListener("click",(async()=>{const t=e.querySelector("#email").value.trim();if(!t)return n.textContent="Please enter your email address first",void n.classList.remove("hidden");n.classList.add("hidden"),i.disabled=!0,i.textContent="Sending...";try{const e={email:t},n=await api("/auth/resend-verification",{method:"POST",body:e});n?.csrfToken&&setCsrfToken(n.csrfToken),alert(n.message||"Verification email sent! Please check your inbox.")}catch(e){const t=e;n.textContent=t.message||"Failed to resend verification email.",n.classList.remove("hidden")}finally{i.disabled=!1,i.textContent="Resend Verification Email"}}))}function getThemeIcon(){const e=document.documentElement.getAttribute("data-theme"),t=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light";return icon("dark"===(e||t)?Icons.SUN:Icons.MOON,"icon icon-lg")}