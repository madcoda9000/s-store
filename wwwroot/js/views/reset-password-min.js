import{api,setCsrfToken}from"../api.js";import{hideHeader}from"../header.js";import{icon,Icons}from"../icons.js";export function registerResetPassword(e){e("/reset-password",(e=>{hideHeader();const t=new URLSearchParams(location.hash.split("?")[1]||""),n=t.get("token")||"",s=t.get("email")||"";e.innerHTML=`\n      <div class="auth-container">\n        <div class="auth-wrapper">\n          <div class="card auth-card">\n            \n            <div class="auth-header">\n              <h1 class="auth-logo">S-Store</h1>\n              <p class="text-muted">Set your new password</p>\n            </div>\n            \n            <form id="reset-password-form" class="form">\n              <div class="form-group">\n                <label class="label" for="email">Email Address</label>\n                <input \n                  type="email" \n                  id="email" \n                  name="email" \n                  class="input" \n                  placeholder="name@example.com"\n                  autocomplete="email"\n                  value="${s}"\n                  required>\n              </div>\n              \n              ${n?"":'\n              <div class="form-group">\n                <label class="label" for="code">6-Digit Reset Code</label>\n                <input \n                  type="text" \n                  id="code" \n                  name="code" \n                  class="input" \n                  placeholder="123456"\n                  maxlength="6"\n                  pattern="[0-9]{6}"\n                  autocomplete="off"\n                  required>\n                <span class="form-hint">Enter the code from your email</span>\n              </div>\n              '}\n              \n              <div class="form-group">\n                <label class="label" for="password">New Password</label>\n                <div class="input-with-actions" style="--action-btn-count: 2;">\n                  <input \n                    type="password" \n                    id="password" \n                    name="password" \n                    class="input" \n                    placeholder="••••••••"\n                    autocomplete="new-password"\n                    minlength="8"\n                    required>\n                  <button type="button" class="input-action-btn" id="generate-password" title="Generate secure password">\n                    ${icon(Icons.KEY,"icon")}\n                  </button>\n                  <button type="button" class="input-action-btn" id="toggle-password" title="Show/hide password">\n                    ${icon(Icons.EYE,"icon")}\n                  </button>\n                </div>\n                <span class="form-hint">Minimum 8 characters</span>\n              </div>\n              \n              <div class="form-group">\n                <label class="label" for="confirm-password">Confirm New Password</label>\n                <input \n                  type="password" \n                  id="confirm-password" \n                  name="confirm-password" \n                  class="input" \n                  placeholder="••••••••"\n                  autocomplete="new-password"\n                  minlength="8"\n                  required>\n              </div>\n              \n              <input type="hidden" name="token" value="${n}">\n              \n              <div id="reset-password-error" class="error hidden"></div>\n              <div id="reset-password-success" class="alert alert-success hidden"></div>\n              \n              <button type="submit" class="btn btn-primary btn-block">Reset Password</button>\n            </form>\n            \n            <div class="auth-footer">\n              <p class="text-muted">\n                <a href="#/login" class="link">Back to login</a> • \n                <a href="#/forgot-password" class="link">Resend reset link</a>\n              </p>\n            </div>\n          </div>\n\n          <div class="auth-theme-toggle">\n            <button class="btn btn-icon" id="auth-theme-toggle" aria-label="Toggle theme">${getThemeIcon()}</button>\n          </div>\n        \n        </div>\n      </div>`;const o=e.querySelector("#reset-password-form"),a=e.querySelector("#reset-password-error"),r=e.querySelector("#reset-password-success"),i=e.querySelector("#auth-theme-toggle"),d=o.querySelector('button[type="submit"]'),l=e.querySelector("#password"),c=e.querySelector("#confirm-password"),p=e.querySelector("#toggle-password"),m=e.querySelector("#generate-password");i&&i.addEventListener("click",(()=>{const e=document.documentElement,t="light"===e.getAttribute("data-theme")?"dark":"light";e.setAttribute("data-theme",t),localStorage.setItem("theme",t),i.innerHTML=getThemeIcon()})),p&&p.addEventListener("click",(()=>{const e="password"===l.type;l.type=e?"text":"password",c.type=e?"text":"password",p.innerHTML=icon(e?Icons.EYE_OFF:Icons.EYE,"icon")})),m&&m.addEventListener("click",(()=>{const e=generateSecurePassword();l.value=e,c.value=e,l.type="text",c.type="text",p&&(p.innerHTML=icon(Icons.EYE_OFF,"icon"))})),o.addEventListener("submit",(async e=>{e.preventDefault(),a.classList.add("hidden"),a.textContent="",r.classList.add("hidden"),r.textContent="";const t=new FormData(o),n=t.get("password")?.toString()||"";if(n!==(t.get("confirm-password")?.toString()||""))return a.textContent="Passwords do not match",void a.classList.remove("hidden");const s={email:t.get("email")?.toString()||"",token:t.get("token")?.toString()||"",code:t.get("code")?.toString()||"",newPassword:n};d.disabled=!0,d.textContent="Resetting...";try{const e=await api("/auth/reset-password",{method:"POST",body:s});e?.csrfToken&&setCsrfToken(e.csrfToken),r.textContent=e?.message||"Password reset successful. Redirecting to login...",r.classList.remove("hidden"),o.reset(),setTimeout((()=>{location.hash="/login"}),2e3)}catch(e){const t=e;a.textContent=t.message||"Failed to reset password. Please try again.",a.classList.remove("hidden"),d.disabled=!1,d.textContent="Reset Password"}}))}))}function getThemeIcon(){const e=document.documentElement.getAttribute("data-theme"),t=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light";return icon("dark"===(e||t)?Icons.SUN:Icons.MOON,"icon icon-lg")}function generateSecurePassword(){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZ",t="abcdefghijklmnopqrstuvwxyz",n="0123456789",s="!@#$%^&*()_+-=[]{}|;:,.<>?",o=e+t+n+s;let a="";a+=e[Math.floor(Math.random()*e.length)],a+=t[Math.floor(Math.random()*t.length)],a+=n[Math.floor(Math.random()*n.length)],a+=s[Math.floor(Math.random()*s.length)];for(let e=a.length;e<16;e++)a+=o[Math.floor(Math.random()*o.length)];return a.split("").sort((()=>Math.random()-.5)).join("")}